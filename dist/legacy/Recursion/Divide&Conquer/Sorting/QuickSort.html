<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quick Sort - Interactive Whiteboard</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Patrick+Hand&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Patrick Hand", cursive;
        background: #1a1a2e;
        min-height: 100vh;
        padding: 20px;
      }

      .whiteboard {
        background: linear-gradient(
          135deg,
          #1a472a 0%,
          #2d5a3d 50%,
          #1a472a 100%
        );
        border-radius: 12px;
        padding: 40px;
        max-width: 1400px;
        margin: 0 auto;
        box-shadow:
          inset 0 0 100px rgba(0, 0, 0, 0.3),
          0 10px 40px rgba(0, 0, 0, 0.5);
        position: relative;
        overflow: hidden;
      }

      .whiteboard::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        pointer-events: none;
      }

      .board-frame {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 15px solid #5d4037;
        border-radius: 12px;
        pointer-events: none;
        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
      }

      .title {
        font-family: "Caveat", cursive;
        font-size: 3.2rem;
        color: #fff;
        text-align: center;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .subtitle {
        font-size: 1.3rem;
        color: #a8e6cf;
        text-align: center;
        margin-bottom: 25px;
        position: relative;
      }

      .chalk-line {
        height: 3px;
        background: linear-gradient(90deg, transparent, #fff, transparent);
        margin: 15px auto;
        width: 60%;
        opacity: 0.5;
      }

      .main-container {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 30px;
        position: relative;
      }

      @media (max-width: 1100px) {
        .main-container {
          grid-template-columns: 1fr;
        }
      }

      .visualization-area {
        position: relative;
      }

      .array-section {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
      }

      .section-title {
        color: #ffeb3b;
        font-size: 1.4rem;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .array-container {
        display: flex;
        justify-content: center;
        align-items: flex-end;
        gap: 8px;
        min-height: 180px;
        flex-wrap: wrap;
      }

      .array-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: all 0.4s ease;
      }

      .array-bar {
        width: 60px;
        background: linear-gradient(180deg, #ffeb3b 0%, #ffc107 100%);
        border: 3px solid #fff;
        border-radius: 8px 8px 4px 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        font-weight: bold;
        color: #333;
        transition: all 0.3s ease;
        position: relative;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .array-bar.pivot {
        background: linear-gradient(180deg, #e91e63 0%, #c2185b 100%);
        border-color: #fff;
        box-shadow: 0 0 25px rgba(233, 30, 99, 0.6);
        transform: scale(1.1);
      }

      .array-bar.comparing {
        background: linear-gradient(180deg, #ff7043 0%, #e64a19 100%);
        box-shadow: 0 0 20px rgba(255, 112, 67, 0.5);
      }

      .array-bar.swapping {
        background: linear-gradient(180deg, #9c27b0 0%, #7b1fa2 100%);
        animation: swap-pulse 0.4s ease;
      }

      .array-bar.sorted {
        background: linear-gradient(180deg, #66bb6a 0%, #43a047 100%);
      }

      .array-bar.in-range {
        border-color: #00bcd4;
        border-width: 4px;
      }

      .array-bar.out-of-range {
        opacity: 0.3;
      }

      .array-bar.i-pointer {
        box-shadow:
          0 -5px 0 0 #2196f3,
          0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .array-bar.j-pointer {
        box-shadow:
          0 5px 0 0 #ff9800,
          0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .array-bar.pivot-final {
        background: linear-gradient(180deg, #4caf50 0%, #388e3c 100%);
        animation: celebrate 0.5s ease;
      }

      @keyframes swap-pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
      }

      @keyframes celebrate {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.15) rotate(5deg);
        }
      }

      .index-label {
        color: #90caf9;
        font-size: 1rem;
        margin-top: 8px;
      }

      .pointer-row {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 10px;
        min-height: 50px;
      }

      .pointer-slot {
        width: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 1.2rem;
      }

      .pointer-i {
        color: #2196f3;
      }

      .pointer-j {
        color: #ff9800;
      }

      .pointer-arrow {
        animation: bounce 0.6s ease infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }

      .step-explanation {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        border-left: 5px solid #ffeb3b;
        margin-bottom: 20px;
        position: relative;
      }

      .step-explanation h3 {
        color: #ffeb3b;
        font-size: 1.3rem;
        margin-bottom: 10px;
      }

      .step-explanation p {
        color: #fff;
        font-size: 1.15rem;
        line-height: 1.5;
      }

      .code-display {
        font-family: "Courier New", monospace;
        color: #a5d6a7;
        font-size: 1rem;
        background: rgba(0, 0, 0, 0.3);
        padding: 12px 15px;
        border-radius: 8px;
        margin-top: 12px;
        overflow-x: auto;
      }

      .highlight {
        background: rgba(255, 235, 59, 0.3);
        padding: 2px 6px;
        border-radius: 4px;
      }

      .info-panel {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        padding: 20px;
        position: relative;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .info-box {
        text-align: center;
        background: rgba(255, 255, 255, 0.05);
        padding: 12px;
        border-radius: 8px;
      }

      .info-label {
        color: #a5d6a7;
        font-size: 1rem;
        margin-bottom: 5px;
      }

      .info-value {
        color: #fff;
        font-size: 1.5rem;
        font-family: "Caveat", cursive;
      }

      .partition-visual {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 15px;
        margin: 15px 0;
        text-align: center;
      }

      .partition-diagram {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
        flex-wrap: wrap;
        margin: 10px 0;
      }

      .partition-section {
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 1.1rem;
        color: #fff;
      }

      .section-left {
        background: linear-gradient(180deg, #2196f3 0%, #1976d2 100%);
      }

      .section-pivot {
        background: linear-gradient(180deg, #e91e63 0%, #c2185b 100%);
      }

      .section-right {
        background: linear-gradient(180deg, #ff9800 0%, #f57c00 100%);
      }

      .recursion-tree {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 15px;
        margin-top: 15px;
      }

      .tree-title {
        color: #a5d6a7;
        font-size: 1.2rem;
        margin-bottom: 10px;
        text-align: center;
      }

      .call-stack {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .stack-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px 15px;
        border-radius: 8px;
        color: #fff;
        font-size: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .stack-item.active {
        background: linear-gradient(
          90deg,
          rgba(76, 175, 80, 0.3),
          rgba(76, 175, 80, 0.1)
        );
        border-left: 4px solid #4caf50;
      }

      .stack-item.completed {
        opacity: 0.5;
        text-decoration: line-through;
      }

      .stack-status {
        font-size: 0.9rem;
        padding: 3px 8px;
        border-radius: 4px;
      }

      .status-active {
        background: #4caf50;
      }

      .status-pending {
        background: #ff9800;
      }

      .status-done {
        background: #9e9e9e;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
        margin: 20px 0;
        position: relative;
      }

      .btn {
        font-family: "Patrick Hand", cursive;
        font-size: 1.1rem;
        padding: 10px 25px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(180deg, #4caf50 0%, #388e3c 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
      }

      .btn-secondary {
        background: linear-gradient(180deg, #2196f3 0%, #1976d2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
      }

      .btn-warning {
        background: linear-gradient(180deg, #ff9800 0%, #f57c00 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
      }

      .btn-danger {
        background: linear-gradient(180deg, #f44336 0%, #d32f2f 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
      }

      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .speed-control {
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: center;
        margin: 15px 0;
        position: relative;
      }

      .speed-label {
        color: #fff;
        font-size: 1.1rem;
      }

      .speed-slider {
        width: 120px;
        height: 8px;
        -webkit-appearance: none;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        outline: none;
      }

      .speed-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 22px;
        height: 22px;
        background: #ffeb3b;
        border-radius: 50%;
        cursor: pointer;
      }

      .legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 2px dashed rgba(255, 255, 255, 0.2);
        position: relative;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .legend-color {
        width: 25px;
        height: 25px;
        border-radius: 5px;
        border: 2px solid #fff;
      }

      .legend-text {
        color: #fff;
        font-size: 1rem;
      }

      .complexity-box {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        padding: 15px;
        margin-top: 20px;
        text-align: center;
        position: relative;
      }

      .complexity-title {
        color: #a5d6a7;
        font-size: 1.2rem;
        margin-bottom: 12px;
      }

      .complexity-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .complexity-item {
        text-align: center;
      }

      .complexity-label {
        color: #90caf9;
        font-size: 0.95rem;
      }

      .complexity-value {
        color: #ffeb3b;
        font-size: 1.4rem;
        font-family: "Caveat", cursive;
      }

      .status-bar {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        margin: 15px 0;
        position: relative;
      }

      .status-text {
        color: #fff;
        font-size: 1.3rem;
      }

      .status-text.success {
        color: #4caf50;
      }

      .status-text.action {
        color: #ff9800;
      }

      .pivot-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #e91e63;
        color: #fff;
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 10px;
      }

      .variable-display {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 15px 0;
        flex-wrap: wrap;
      }

      .variable {
        text-align: center;
      }

      .var-name {
        color: #90caf9;
        font-size: 1rem;
      }

      .var-value {
        color: #ffeb3b;
        font-size: 1.8rem;
        font-family: "Caveat", cursive;
      }
    </style>
  </head>
  <body>
    <div class="whiteboard">
      <div class="board-frame"></div>

      <h1 class="title">‚ö° Quick Sort Algorithm</h1>
      <p class="subtitle">
        Divide & Conquer: Partition around a pivot, then recursively sort!
      </p>

      <div class="chalk-line"></div>

      <div class="main-container">
        <div class="visualization-area">
          <div class="step-explanation">
            <h3 id="step-title">üéØ Quick Sort Overview</h3>
            <p id="step-description">
              Click "Start" to begin sorting [4, 1, 3, 9, 7]. We'll pick the
              last element as pivot, partition the array, and recursively sort
              the subarrays!
            </p>
            <div class="code-display" id="code-display">
              // Quick Sort: O(n log n) average case<br />
              // 1. Choose pivot (last element)<br />
              // 2. Partition: elements ‚â§ pivot go left<br />
              // 3. Recursively sort left & right
            </div>
          </div>

          <div class="array-section">
            <div class="section-title">üìä Array Visualization</div>
            <div class="array-container" id="array-container"></div>
            <div class="pointer-row" id="pointer-row"></div>

            <div class="variable-display" id="variable-display">
              <div class="variable">
                <div class="var-name">low</div>
                <div class="var-value" id="var-low">-</div>
              </div>
              <div class="variable">
                <div class="var-name">high</div>
                <div class="var-value" id="var-high">-</div>
              </div>
              <div class="variable">
                <div class="var-name">pivot</div>
                <div class="var-value" id="var-pivot">-</div>
              </div>
              <div class="variable">
                <div class="var-name">i</div>
                <div class="var-value" id="var-i">-</div>
              </div>
              <div class="variable">
                <div class="var-name">j</div>
                <div class="var-value" id="var-j">-</div>
              </div>
            </div>
          </div>

          <div
            class="partition-visual"
            id="partition-visual"
            style="display: none"
          >
            <div style="color: #a5d6a7; font-size: 1.1rem; margin-bottom: 10px">
              Partition Result:
            </div>
            <div class="partition-diagram" id="partition-diagram"></div>
          </div>

          <div class="status-bar">
            <div class="status-text" id="status-text">
              Press "Start" to begin Quick Sort!
            </div>
          </div>

          <div class="controls">
            <button
              class="btn btn-primary"
              id="start-btn"
              onclick="startSort()"
            >
              ‚ñ∂Ô∏è Start
            </button>
            <button
              class="btn btn-secondary"
              id="step-btn"
              onclick="nextStep()"
              disabled
            >
              ‚è≠Ô∏è Next Step
            </button>
            <button
              class="btn btn-warning"
              id="auto-btn"
              onclick="toggleAuto()"
              disabled
            >
              üîÑ Auto Play
            </button>
            <button class="btn btn-danger" id="reset-btn" onclick="resetSort()">
              üîÉ Reset
            </button>
          </div>

          <div class="speed-control">
            <span class="speed-label">Speed:</span>
            <input
              type="range"
              class="speed-slider"
              id="speed-slider"
              min="200"
              max="2000"
              value="800"
            />
            <span class="speed-label" id="speed-value">Medium</span>
          </div>

          <div class="legend">
            <div class="legend-item">
              <div
                class="legend-color"
                style="
                  background: linear-gradient(180deg, #ffeb3b 0%, #ffc107 100%);
                "
              ></div>
              <span class="legend-text">Unsorted</span>
            </div>
            <div class="legend-item">
              <div
                class="legend-color"
                style="
                  background: linear-gradient(180deg, #e91e63 0%, #c2185b 100%);
                "
              ></div>
              <span class="legend-text">Pivot</span>
            </div>
            <div class="legend-item">
              <div
                class="legend-color"
                style="
                  background: linear-gradient(180deg, #ff7043 0%, #e64a19 100%);
                "
              ></div>
              <span class="legend-text">Comparing</span>
            </div>
            <div class="legend-item">
              <div
                class="legend-color"
                style="
                  background: linear-gradient(180deg, #9c27b0 0%, #7b1fa2 100%);
                "
              ></div>
              <span class="legend-text">Swapping</span>
            </div>
            <div class="legend-item">
              <div
                class="legend-color"
                style="
                  background: linear-gradient(180deg, #66bb6a 0%, #43a047 100%);
                "
              ></div>
              <span class="legend-text">Sorted</span>
            </div>
          </div>
        </div>

        <div class="sidebar">
          <div class="info-panel">
            <div class="section-title">üìà Statistics</div>
            <div class="info-grid">
              <div class="info-box">
                <div class="info-label">Comparisons</div>
                <div class="info-value" id="comparisons">0</div>
              </div>
              <div class="info-box">
                <div class="info-label">Swaps</div>
                <div class="info-value" id="swaps">0</div>
              </div>
              <div class="info-box">
                <div class="info-label">Partitions</div>
                <div class="info-value" id="partitions">0</div>
              </div>
              <div class="info-box">
                <div class="info-label">Recursion Depth</div>
                <div class="info-value" id="depth">0</div>
              </div>
            </div>
          </div>

          <div class="recursion-tree">
            <div class="tree-title">üìö Call Stack</div>
            <div class="call-stack" id="call-stack">
              <div class="stack-item" style="opacity: 0.5">
                <span>Waiting to start...</span>
              </div>
            </div>
          </div>

          <div class="complexity-box">
            <div class="complexity-title">üìä Complexity</div>
            <div class="complexity-grid">
              <div class="complexity-item">
                <div class="complexity-label">Best</div>
                <div class="complexity-value">O(n log n)</div>
              </div>
              <div class="complexity-item">
                <div class="complexity-label">Average</div>
                <div class="complexity-value">O(n log n)</div>
              </div>
              <div class="complexity-item">
                <div class="complexity-label">Worst</div>
                <div class="complexity-value">O(n¬≤)</div>
              </div>
              <div class="complexity-item">
                <div class="complexity-label">Space</div>
                <div class="complexity-value">O(log n)</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initial array
      const originalArray = [4, 1, 3, 9, 7];
      let array = [...originalArray];
      let n = array.length;

      // Statistics
      let comparisons = 0;
      let swapCount = 0;
      let partitionCount = 0;
      let maxDepth = 0;

      // State
      let sortedIndices = new Set();
      let isRunning = false;
      let isAutoPlay = false;
      let autoPlayInterval = null;

      // Step queue for visualization
      let steps = [];
      let currentStepIndex = 0;

      // Speed control
      const speedSlider = document.getElementById("speed-slider");
      speedSlider.addEventListener("input", updateSpeed);

      function updateSpeed() {
        const value = speedSlider.value;
        const label = document.getElementById("speed-value");
        if (value < 600) label.textContent = "Fast";
        else if (value < 1400) label.textContent = "Medium";
        else label.textContent = "Slow";
      }

      function getSpeed() {
        return parseInt(speedSlider.value);
      }

      // Generate all steps beforehand
      function generateSteps() {
        steps = [];
        const arr = [...originalArray];
        const sorted = new Set();

        function addStep(type, data) {
          steps.push({
            type,
            data: { ...data, array: [...arr], sorted: new Set(sorted) },
          });
        }

        function partition(low, high, depth) {
          const pivot = arr[high];
          addStep("partition-start", {
            low,
            high,
            pivot,
            pivotIndex: high,
            depth,
          });

          let i = low - 1;
          addStep("init-i", { low, high, pivot, i, depth });

          for (let j = low; j < high; j++) {
            addStep("compare", {
              low,
              high,
              pivot,
              i,
              j,
              element: arr[j],
              depth,
            });

            if (arr[j] <= pivot) {
              i++;
              addStep("increment-i", { low, high, pivot, i, j, depth });

              if (i !== j) {
                addStep("swap", {
                  low,
                  high,
                  pivot,
                  i,
                  j,
                  val1: arr[i],
                  val2: arr[j],
                  depth,
                });
                [arr[i], arr[j]] = [arr[j], arr[i]];
                addStep("swap-done", { low, high, pivot, i, j, depth });
              }
            } else {
              addStep("skip", {
                low,
                high,
                pivot,
                i,
                j,
                element: arr[j],
                depth,
              });
            }
          }

          // Final pivot swap
          addStep("pivot-swap", {
            low,
            high,
            pivot,
            i,
            finalPos: i + 1,
            depth,
          });
          [arr[i + 1], arr[high]] = [arr[high], arr[i + 1]];
          sorted.add(i + 1);
          addStep("pivot-placed", {
            low,
            high,
            pivot,
            pivotIndex: i + 1,
            depth,
          });

          return i + 1;
        }

        function quickSort(low, high, depth = 0) {
          if (low < high) {
            addStep("call", { low, high, depth });

            const pi = partition(low, high, depth);

            addStep("recurse-left", { low, high, pi, depth });
            quickSort(low, pi - 1, depth + 1);

            addStep("recurse-right", { low, high, pi, depth });
            quickSort(pi + 1, high, depth + 1);

            addStep("return", { low, high, depth });
          } else if (low === high) {
            sorted.add(low);
            addStep("base-case", { index: low, depth });
          } else {
            addStep("empty-range", { low, high, depth });
          }
        }

        addStep("start", {});
        quickSort(0, arr.length - 1, 0);
        addStep("complete", {});
      }

      function initVisualization() {
        const container = document.getElementById("array-container");
        const pointerRow = document.getElementById("pointer-row");
        container.innerHTML = "";
        pointerRow.innerHTML = "";

        array.forEach((value, index) => {
          const item = document.createElement("div");
          item.className = "array-item";

          const bar = document.createElement("div");
          bar.className = "array-bar";
          bar.id = `bar-${index}`;
          bar.style.height = `${value * 15 + 50}px`;
          bar.textContent = value;

          const label = document.createElement("div");
          label.className = "index-label";
          label.textContent = `[${index}]`;

          item.appendChild(bar);
          item.appendChild(label);
          container.appendChild(item);

          // Pointer slot
          const slot = document.createElement("div");
          slot.className = "pointer-slot";
          slot.id = `ptr-${index}`;
          pointerRow.appendChild(slot);
        });
      }

      function updateStats() {
        document.getElementById("comparisons").textContent = comparisons;
        document.getElementById("swaps").textContent = swapCount;
        document.getElementById("partitions").textContent = partitionCount;
        document.getElementById("depth").textContent = maxDepth;
      }

      function clearHighlights() {
        document.querySelectorAll(".array-bar").forEach((bar) => {
          bar.classList.remove(
            "pivot",
            "comparing",
            "swapping",
            "in-range",
            "out-of-range",
            "i-pointer",
            "j-pointer",
            "pivot-final",
          );
        });
        document.querySelectorAll(".pointer-slot").forEach((slot) => {
          slot.innerHTML = "";
        });
      }

      function updateArrayDisplay(arr, sorted) {
        arr.forEach((value, index) => {
          const bar = document.getElementById(`bar-${index}`);
          bar.textContent = value;
          bar.style.height = `${value * 15 + 50}px`;
          if (sorted.has(index)) {
            bar.classList.add("sorted");
          }
        });
      }

      function highlightRange(low, high) {
        for (let i = 0; i < n; i++) {
          const bar = document.getElementById(`bar-${i}`);
          if (i >= low && i <= high) {
            bar.classList.add("in-range");
          } else {
            bar.classList.add("out-of-range");
          }
        }
      }

      function showPointer(index, type, label) {
        const slot = document.getElementById(`ptr-${index}`);
        if (slot && index >= 0 && index < n) {
          const pointer = document.createElement("div");
          pointer.className = type === "i" ? "pointer-i" : "pointer-j";
          pointer.innerHTML = `<div class="pointer-arrow">‚Üë</div><div>${label}</div>`;
          slot.appendChild(pointer);
        }
      }

      function updateVariables(data) {
        document.getElementById("var-low").textContent =
          data.low !== undefined ? data.low : "-";
        document.getElementById("var-high").textContent =
          data.high !== undefined ? data.high : "-";
        document.getElementById("var-pivot").textContent =
          data.pivot !== undefined ? data.pivot : "-";
        document.getElementById("var-i").textContent =
          data.i !== undefined ? data.i : "-";
        document.getElementById("var-j").textContent =
          data.j !== undefined ? data.j : "-";
      }

      function updateCallStack(depth, low, high, status) {
        const stack = document.getElementById("call-stack");
        const items = stack.querySelectorAll(".stack-item");

        // Create new item for this call
        if (status === "active") {
          const item = document.createElement("div");
          item.className = "stack-item active";
          item.dataset.depth = depth;
          item.innerHTML = `
                    <span>quickSort(${low}, ${high})</span>
                    <span class="stack-status status-active">Active</span>
                `;
          stack.appendChild(item);
        }
      }

      function setExplanation(title, description, code) {
        document.getElementById("step-title").textContent = title;
        document.getElementById("step-description").textContent = description;
        document.getElementById("code-display").innerHTML = code;
      }

      function setStatus(text, className = "") {
        const status = document.getElementById("status-text");
        status.textContent = text;
        status.className = "status-text " + className;
      }

      function executeStep(step) {
        const { type, data } = step;

        clearHighlights();
        updateArrayDisplay(data.array, data.sorted);

        // Re-apply sorted highlights
        data.sorted.forEach((i) => {
          document.getElementById(`bar-${i}`).classList.add("sorted");
        });

        switch (type) {
          case "start":
            setExplanation(
              "üöÄ Starting Quick Sort!",
              "We'll sort the array using Quick Sort. The algorithm picks a pivot (last element), partitions the array so elements ‚â§ pivot go left and > pivot go right, then recursively sorts the subarrays.",
              "quickSort(arr, 0, " + (n - 1) + ")",
            );
            setStatus(
              "Starting Quick Sort on [" + originalArray.join(", ") + "]",
            );
            break;

          case "call":
            maxDepth = Math.max(maxDepth, data.depth);
            updateStats();
            highlightRange(data.low, data.high);
            updateVariables(data);
            updateCallStack(data.depth, data.low, data.high, "active");
            setExplanation(
              `üìû quickSort(${data.low}, ${data.high})`,
              `Recursive call at depth ${data.depth}. Working on subarray from index ${data.low} to ${data.high}: [${data.array.slice(data.low, data.high + 1).join(", ")}]`,
              `<span class="highlight">quickSort(arr, ${data.low}, ${data.high})</span><br>// Depth: ${data.depth}`,
            );
            setStatus(`Processing subarray [${data.low}...${data.high}]`);
            break;

          case "partition-start":
            partitionCount++;
            updateStats();
            highlightRange(data.low, data.high);
            document
              .getElementById(`bar-${data.pivotIndex}`)
              .classList.add("pivot");
            updateVariables(data);
            setExplanation(
              `üéØ Partition: pivot = ${data.pivot}`,
              `Starting partition. Pivot is arr[${data.high}] = ${data.pivot}. We'll rearrange so all elements ‚â§ ${data.pivot} are on the left.`,
              `pivot = arr[${data.high}] = <span class="highlight">${data.pivot}</span><br>// Partition arr[${data.low}...${data.high}]`,
            );
            setStatus(`Partitioning with pivot = ${data.pivot}`, "action");
            break;

          case "init-i":
            highlightRange(data.low, data.high);
            document.getElementById(`bar-${data.high}`).classList.add("pivot");
            updateVariables(data);
            setExplanation(
              `üìç Initialize i = ${data.i}`,
              `i starts at ${data.low - 1} (one before low). i tracks the boundary of elements ‚â§ pivot. Everything at index ‚â§ i is ‚â§ pivot.`,
              `let i = low - 1 = <span class="highlight">${data.i}</span><br>// i marks the "small elements" boundary`,
            );
            setStatus(`i = ${data.i} (boundary for elements ‚â§ pivot)`);
            break;

          case "compare":
            comparisons++;
            updateStats();
            highlightRange(data.low, data.high);
            document.getElementById(`bar-${data.high}`).classList.add("pivot");
            document.getElementById(`bar-${data.j}`).classList.add("comparing");
            if (data.i >= data.low) {
              document
                .getElementById(`bar-${data.i}`)
                .classList.add("i-pointer");
            }
            showPointer(data.i, "i", "i=" + data.i);
            showPointer(data.j, "j", "j=" + data.j);
            updateVariables(data);
            const willSwap = data.element <= data.pivot;
            setExplanation(
              `üîç Compare: arr[${data.j}] = ${data.element}`,
              `Is ${data.element} ‚â§ ${data.pivot}? ${willSwap ? "YES! Move it to the left partition." : "NO. Leave it in place (right partition)."}`,
              `if (arr[${data.j}] <= pivot)<br>if (<span class="highlight">${data.element} <= ${data.pivot}</span>) ‚Üí ${willSwap ? "TRUE" : "FALSE"}`,
            );
            setStatus(
              `Comparing: ${data.element} ${willSwap ? "‚â§" : ">"} ${data.pivot}`,
              willSwap ? "action" : "",
            );
            break;

          case "increment-i":
            highlightRange(data.low, data.high);
            document.getElementById(`bar-${data.high}`).classList.add("pivot");
            if (data.i >= data.low) {
              document
                .getElementById(`bar-${data.i}`)
                .classList.add("i-pointer");
            }
            showPointer(data.i, "i", "i=" + data.i);
            showPointer(data.j, "j", "j=" + data.j);
            updateVariables(data);
            setExplanation(
              `‚û°Ô∏è Increment i to ${data.i}`,
              `Element qualifies for left partition. Expand the boundary by incrementing i. Now i = ${data.i}.`,
              `i++  // <span class="highlight">i = ${data.i}</span>`,
            );
            setStatus(`i incremented to ${data.i}`);
            break;

          case "swap":
            highlightRange(data.low, data.high);
            document.getElementById(`bar-${data.high}`).classList.add("pivot");
            document.getElementById(`bar-${data.i}`).classList.add("swapping");
            document.getElementById(`bar-${data.j}`).classList.add("swapping");
            showPointer(data.i, "i", "i=" + data.i);
            showPointer(data.j, "j", "j=" + data.j);
            updateVariables(data);
            setExplanation(
              `üîÑ Swap arr[${data.i}] ‚Üî arr[${data.j}]`,
              `Swapping ${data.val1} and ${data.val2} to move the smaller element into the left partition.`,
              `<span class="highlight">swap(arr[${data.i}], arr[${data.j}])</span><br>// ${data.val1} ‚Üî ${data.val2}`,
            );
            setStatus(`Swapping ${data.val1} ‚Üî ${data.val2}`, "action");
            break;

          case "swap-done":
            swapCount++;
            updateStats();
            highlightRange(data.low, data.high);
            document.getElementById(`bar-${data.high}`).classList.add("pivot");
            showPointer(data.i, "i", "i=" + data.i);
            showPointer(data.j, "j", "j=" + data.j);
            updateVariables(data);
            setExplanation(
              `‚úÖ Swap Complete`,
              `Elements swapped. Array is now [${data.array.join(", ")}]. Continue scanning...`,
              `// Array: [${data.array.join(", ")}]`,
            );
            setStatus(
              `Swap complete. Array: [${data.array.join(", ")}]`,
              "success",
            );
            break;

          case "skip":
            highlightRange(data.low, data.high);
            document.getElementById(`bar-${data.high}`).classList.add("pivot");
            document.getElementById(`bar-${data.j}`).classList.add("comparing");
            showPointer(data.i, "i", "i=" + data.i);
            showPointer(data.j, "j", "j=" + data.j);
            updateVariables(data);
            setExplanation(
              `‚è≠Ô∏è Skip: ${data.element} > ${data.pivot}`,
              `${data.element} is greater than pivot (${data.pivot}). It already belongs in the right partition. Move to next element.`,
              `// ${data.element} > ${data.pivot} ‚Üí no swap needed<br>// Continue to j = ${data.j + 1}`,
            );
            setStatus(`${data.element} > ${data.pivot}, no swap needed`);
            break;

          case "pivot-swap":
            highlightRange(data.low, data.high);
            document
              .getElementById(`bar-${data.finalPos}`)
              .classList.add("swapping");
            document.getElementById(`bar-${data.high}`).classList.add("pivot");
            updateVariables({ ...data, i: data.i });
            setExplanation(
              `üéØ Place Pivot at Position ${data.finalPos}`,
              `Scanning complete! Now swap pivot (${data.pivot}) into its final sorted position at index ${data.finalPos}.`,
              `<span class="highlight">swap(arr[${data.finalPos}], arr[${data.high}])</span><br>// Put pivot in final position`,
            );
            setStatus(
              `Placing pivot ${data.pivot} at index ${data.finalPos}`,
              "action",
            );
            break;

          case "pivot-placed":
            highlightRange(data.low, data.high);
            document
              .getElementById(`bar-${data.pivotIndex}`)
              .classList.add("pivot-final");
            document
              .getElementById(`bar-${data.pivotIndex}`)
              .classList.add("sorted");
            updateVariables(data);

            // Show partition visual
            const partVis = document.getElementById("partition-visual");
            partVis.style.display = "block";
            const diagram = document.getElementById("partition-diagram");
            const leftPart = data.array.slice(data.low, data.pivotIndex);
            const rightPart = data.array.slice(
              data.pivotIndex + 1,
              data.high + 1,
            );
            diagram.innerHTML = `
                        <div class="partition-section section-left">[${leftPart.join(", ") || "empty"}]<br>‚â§ ${data.pivot}</div>
                        <div class="partition-section section-pivot">${data.pivot}<br>PIVOT</div>
                        <div class="partition-section section-right">[${rightPart.join(", ") || "empty"}]<br>> ${data.pivot}</div>
                    `;

            setExplanation(
              `‚úÖ Pivot ${data.pivot} is SORTED!`,
              `Pivot is now at its final position (index ${data.pivotIndex}). Left partition: [${leftPart.join(", ") || "empty"}], Right partition: [${rightPart.join(", ") || "empty"}]`,
              `return ${data.pivotIndex}  // <span class="highlight">Pivot index</span>`,
            );
            setStatus(
              `Pivot ${data.pivot} placed at index ${data.pivotIndex}!`,
              "success",
            );
            break;

          case "recurse-left":
            highlightRange(data.low, data.pi - 1);
            document.getElementById(`bar-${data.pi}`).classList.add("sorted");
            setExplanation(
              `‚¨ÖÔ∏è Recurse Left: [${data.low}...${data.pi - 1}]`,
              `Now recursively sort the left subarray (elements ‚â§ pivot).`,
              `quickSort(arr, ${data.low}, ${data.pi - 1})<br>// Sort left partition`,
            );
            setStatus(
              `Recursing into left partition [${data.low}...${data.pi - 1}]`,
            );
            document.getElementById("partition-visual").style.display = "none";
            break;

          case "recurse-right":
            highlightRange(data.pi + 1, data.high);
            document.getElementById(`bar-${data.pi}`).classList.add("sorted");
            setExplanation(
              `‚û°Ô∏è Recurse Right: [${data.pi + 1}...${data.high}]`,
              `Now recursively sort the right subarray (elements > pivot).`,
              `quickSort(arr, ${data.pi + 1}, ${data.high})<br>// Sort right partition`,
            );
            setStatus(
              `Recursing into right partition [${data.pi + 1}...${data.high}]`,
            );
            break;

          case "base-case":
            document
              .getElementById(`bar-${data.index}`)
              .classList.add("sorted");
            setExplanation(
              `üìç Base Case: Single Element`,
              `Only one element at index ${data.index}. A single element is already sorted!`,
              `// low >= high ‚Üí Base case<br>// arr[${data.index}] = ${data.array[data.index]} is sorted`,
            );
            setStatus(
              `Single element at index ${data.index} is sorted!`,
              "success",
            );
            break;

          case "empty-range":
            setExplanation(
              `üìç Empty Range`,
              `Range [${data.low}...${data.high}] is empty (low > high). Nothing to sort.`,
              `// low > high ‚Üí Empty subarray<br>// Return immediately`,
            );
            setStatus(`Empty range [${data.low}...${data.high}], skipping`);
            break;

          case "return":
            setExplanation(
              `‚Ü©Ô∏è Return from quickSort(${data.low}, ${data.high})`,
              `Finished sorting subarray [${data.low}...${data.high}]. Returning to caller.`,
              `// Completed sorting [${data.low}...${data.high}]`,
            );
            setStatus(`Completed [${data.low}...${data.high}]`);
            break;

          case "complete":
            // Mark all as sorted
            for (let i = 0; i < n; i++) {
              document.getElementById(`bar-${i}`).classList.add("sorted");
            }
            setExplanation(
              `üéâ Sorting Complete!`,
              `The array is now fully sorted: [${data.array.join(", ")}]. Quick Sort divided the problem into smaller subproblems and conquered each one!`,
              `// Final: [${data.array.join(", ")}]<br>// Comparisons: ${comparisons}, Swaps: ${swapCount}`,
            );
            setStatus(`üéâ Sorted: [${data.array.join(", ")}]`, "success");
            document.getElementById("partition-visual").style.display = "none";

            document.getElementById("step-btn").disabled = true;
            document.getElementById("auto-btn").disabled = true;
            if (isAutoPlay) toggleAuto();
            break;
        }
      }

      function startSort() {
        if (isRunning) return;
        isRunning = true;

        generateSteps();
        currentStepIndex = 0;

        document.getElementById("start-btn").disabled = true;
        document.getElementById("step-btn").disabled = false;
        document.getElementById("auto-btn").disabled = false;

        // Execute first step
        executeStep(steps[currentStepIndex]);
      }

      function nextStep() {
        if (!isRunning || currentStepIndex >= steps.length - 1) return;

        currentStepIndex++;
        executeStep(steps[currentStepIndex]);
      }

      function toggleAuto() {
        isAutoPlay = !isAutoPlay;
        const btn = document.getElementById("auto-btn");

        if (isAutoPlay) {
          btn.textContent = "‚è∏Ô∏è Pause";
          btn.classList.remove("btn-warning");
          btn.classList.add("btn-danger");
          autoPlayInterval = setInterval(() => {
            if (currentStepIndex < steps.length - 1) {
              nextStep();
            } else {
              toggleAuto();
            }
          }, getSpeed());
        } else {
          btn.textContent = "üîÑ Auto Play";
          btn.classList.remove("btn-danger");
          btn.classList.add("btn-warning");
          if (autoPlayInterval) {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
          }
        }
      }

      function resetSort() {
        if (isAutoPlay) toggleAuto();

        array = [...originalArray];
        comparisons = 0;
        swapCount = 0;
        partitionCount = 0;
        maxDepth = 0;
        sortedIndices.clear();
        isRunning = false;
        steps = [];
        currentStepIndex = 0;

        document.getElementById("start-btn").disabled = false;
        document.getElementById("step-btn").disabled = true;
        document.getElementById("auto-btn").disabled = true;

        document.getElementById("partition-visual").style.display = "none";
        document.getElementById("call-stack").innerHTML =
          '<div class="stack-item" style="opacity: 0.5;"><span>Waiting to start...</span></div>';

        clearHighlights();
        initVisualization();
        updateStats();
        updateVariables({});

        setExplanation(
          "üéØ Quick Sort Overview",
          'Click "Start" to begin sorting [4, 1, 3, 9, 7]. We\'ll pick the last element as pivot, partition the array, and recursively sort the subarrays!',
          "// Quick Sort: O(n log n) average case<br>// 1. Choose pivot (last element)<br>// 2. Partition: elements ‚â§ pivot go left<br>// 3. Recursively sort left & right",
        );
        setStatus('Press "Start" to begin Quick Sort!');
      }

      // Initialize
      initVisualization();
      updateStats();
    </script>
  </body>
</html>
