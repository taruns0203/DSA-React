<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iterative Binary Exponentiation - Whiteboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        min-height: 100vh;
        background: #f5f5f0;
        background-image: linear-gradient(
            rgba(0, 100, 200, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 100, 200, 0.03) 1px, transparent 1px);
        background-size: 25px 25px;
        padding: 2rem;
        overflow-x: hidden;
      }

      /* Whiteboard styling */
      .whiteboard {
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
      }

      /* Handwritten style */
      .handwritten {
        font-family: "Caveat", cursive;
      }

      /* Header */
      .header {
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
      }

      .header h1 {
        font-family: "Caveat", cursive;
        font-size: 3.5rem;
        font-weight: 700;
        color: #1a365d;
        text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1);
        transform: rotate(-1deg);
      }

      .header .underline {
        width: 400px;
        height: 8px;
        background: linear-gradient(90deg, #f59e0b, #ef4444, #8b5cf6);
        margin: 0.5rem auto;
        border-radius: 4px;
        transform: rotate(-0.5deg);
      }

      .header p {
        font-family: "Caveat", cursive;
        font-size: 1.5rem;
        color: #4a5568;
        margin-top: 0.5rem;
      }

      /* Controls */
      .controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }

      .control-btn {
        font-family: "Caveat", cursive;
        font-size: 1.5rem;
        padding: 0.75rem 1.5rem;
        border: 3px solid #1a365d;
        background: white;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.1);
      }

      .control-btn:hover {
        transform: translate(-2px, -2px);
        box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.15);
      }

      .control-btn.active {
        background: #1a365d;
        color: white;
      }

      .control-btn.play {
        background: #22c55e;
        border-color: #16a34a;
        color: white;
      }

      .control-btn.play:hover {
        background: #16a34a;
      }

      /* Main sections */
      .section {
        background: white;
        border: 3px solid #2d3748;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.1);
        position: relative;
        transform: rotate(-0.3deg);
      }

      .section:nth-child(even) {
        transform: rotate(0.3deg);
      }

      .section-title {
        font-family: "Caveat", cursive;
        font-size: 2.5rem;
        font-weight: 700;
        color: #1a365d;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .section-title .emoji {
        font-size: 2rem;
      }

      /* Binary breakdown */
      .binary-breakdown {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
      }

      .equation-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-family: "Caveat", cursive;
        font-size: 2rem;
      }

      .number-box {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 700;
        box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.2);
      }

      .binary-display {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: #fef3c7;
        padding: 1rem 2rem;
        border-radius: 12px;
        border: 3px dashed #f59e0b;
      }

      .bit {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.5rem;
        transition: all 0.5s;
      }

      .bit-value {
        font-size: 3rem;
        font-weight: 700;
        color: #1a365d;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        transition: all 0.3s;
      }

      .bit-value.one {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
      }

      .bit-value.zero {
        background: #e2e8f0;
        color: #94a3b8;
      }

      .bit-value.active {
        transform: scale(1.2);
        box-shadow: 0 0 30px rgba(245, 158, 11, 0.8);
      }

      .bit-power {
        font-size: 1.25rem;
        color: #64748b;
        margin-top: 0.5rem;
      }

      .arrow-down {
        font-size: 3rem;
        color: #f59e0b;
        animation: bounce 1s infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(10px);
        }
      }

      /* Power decomposition */
      .power-decomposition {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        font-family: "Caveat", cursive;
        font-size: 2.25rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #dbeafe, #ede9fe);
        border-radius: 16px;
        border: 3px solid #818cf8;
      }

      .power-term {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: all 0.5s;
      }

      .power-term.included {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.2);
      }

      .power-term.excluded {
        color: #94a3b8;
        text-decoration: line-through;
      }

      /* Iteration table */
      .iteration-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-family: "Caveat", cursive;
        font-size: 1.5rem;
      }

      .iteration-table th {
        background: #1a365d;
        color: white;
        padding: 1rem;
        text-align: center;
        font-size: 1.75rem;
      }

      .iteration-table th:first-child {
        border-radius: 12px 0 0 0;
      }

      .iteration-table th:last-child {
        border-radius: 0 12px 0 0;
      }

      .iteration-table td {
        padding: 1rem;
        text-align: center;
        border-bottom: 2px dashed #e2e8f0;
        transition: all 0.5s;
      }

      .iteration-table tr.active td {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        transform: scale(1.02);
      }

      .iteration-table tr.complete td {
        background: #dcfce7;
      }

      .iteration-table tr.pending td {
        opacity: 0.3;
      }

      .include-yes {
        color: #16a34a;
        font-weight: 700;
      }

      .include-no {
        color: #94a3b8;
      }

      .result-update {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 8px;
        display: inline-block;
      }

      /* Current state display */
      .state-display {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
      }

      .state-box {
        background: white;
        border: 3px solid;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.5s;
      }

      .state-box.result {
        border-color: #22c55e;
        background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      }

      .state-box.current {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      }

      .state-box.n {
        border-color: #f59e0b;
        background: linear-gradient(135deg, #fef3c7, #fde68a);
      }

      .state-label {
        font-family: "Caveat", cursive;
        font-size: 1.5rem;
        color: #64748b;
        margin-bottom: 0.5rem;
      }

      .state-value {
        font-family: "Fira Code", monospace;
        font-size: 2rem;
        font-weight: 700;
        color: #1a365d;
      }

      /* Final result */
      .final-result {
        text-align: center;
        padding: 2rem;
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border-radius: 16px;
        border: 4px solid #f59e0b;
        margin-top: 1.5rem;
        transform: rotate(-1deg);
        opacity: 0;
        transition: all 0.5s;
      }

      .final-result.visible {
        opacity: 1;
      }

      .final-result .label {
        font-family: "Caveat", cursive;
        font-size: 2rem;
        color: #92400e;
      }

      .final-result .value {
        font-family: "Caveat", cursive;
        font-size: 4rem;
        font-weight: 700;
        color: #1a365d;
        margin-top: 0.5rem;
      }

      .final-result .calculation {
        font-family: "Caveat", cursive;
        font-size: 1.75rem;
        color: #78350f;
        margin-top: 0.5rem;
      }

      /* Key insight box */
      .insight-box {
        background: linear-gradient(135deg, #fef3c7, #fed7aa);
        border: 3px solid #f59e0b;
        border-radius: 16px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        position: relative;
      }

      .insight-box::before {
        content: "üí°";
        position: absolute;
        top: -20px;
        left: 20px;
        font-size: 2.5rem;
        background: white;
        padding: 0.25rem;
        border-radius: 50%;
      }

      .insight-box p {
        font-family: "Caveat", cursive;
        font-size: 1.5rem;
        color: #78350f;
        line-height: 1.6;
      }

      /* Pseudocode */
      .pseudocode {
        background: #1e293b;
        border-radius: 16px;
        padding: 1.5rem;
        overflow-x: auto;
      }

      .pseudocode pre {
        font-family: "Fira Code", monospace;
        font-size: 1rem;
        color: #e2e8f0;
        line-height: 1.8;
      }

      .pseudocode .keyword {
        color: #c084fc;
      }

      .pseudocode .comment {
        color: #64748b;
      }

      .pseudocode .highlight {
        background: rgba(250, 204, 21, 0.3);
        padding: 0 0.25rem;
        border-radius: 4px;
      }

      .pseudocode .line {
        display: block;
        transition: all 0.3s;
        padding: 0.25rem 0.5rem;
        margin: 0 -0.5rem;
        border-radius: 4px;
      }

      .pseudocode .line.active {
        background: rgba(250, 204, 21, 0.3);
      }

      /* Marker annotations */
      .marker {
        position: absolute;
        font-family: "Caveat", cursive;
        font-size: 1.25rem;
        transform: rotate(-5deg);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
      }

      .marker.red {
        background: #fecaca;
        color: #dc2626;
        border: 2px solid #dc2626;
      }

      .marker.green {
        background: #bbf7d0;
        color: #16a34a;
        border: 2px solid #16a34a;
      }

      .marker.blue {
        background: #bfdbfe;
        color: #2563eb;
        border: 2px solid #2563eb;
      }

      /* Step indicator */
      .step-indicator {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }

      .step-dot {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Caveat", cursive;
        font-size: 1.5rem;
        font-weight: 700;
        transition: all 0.3s;
        border: 3px solid;
      }

      .step-dot.complete {
        background: #22c55e;
        border-color: #16a34a;
        color: white;
      }

      .step-dot.active {
        background: #f59e0b;
        border-color: #d97706;
        color: white;
        transform: scale(1.2);
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
      }

      .step-dot.pending {
        background: #e2e8f0;
        border-color: #cbd5e1;
        color: #94a3b8;
      }

      /* Complexity stats */
      .complexity-stats {
        display: flex;
        justify-content: center;
        gap: 3rem;
        margin-top: 1.5rem;
      }

      .stat {
        text-align: center;
      }

      .stat-icon {
        font-size: 2.5rem;
      }

      .stat-value {
        font-family: "Caveat", cursive;
        font-size: 2rem;
        font-weight: 700;
        color: #16a34a;
      }

      .stat-label {
        font-family: "Caveat", cursive;
        font-size: 1.25rem;
        color: #64748b;
      }

      /* Animation classes */
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .pulse {
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header h1 {
          font-size: 2.5rem;
        }

        .section {
          padding: 1rem;
        }

        .section-title {
          font-size: 1.75rem;
        }

        .bit-value {
          width: 45px;
          height: 45px;
          font-size: 2rem;
        }

        .equation-row {
          font-size: 1.5rem;
          flex-wrap: wrap;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="whiteboard">
      <!-- Header -->
      <div class="header">
        <h1>‚úèÔ∏è Iterative Binary Exponentiation ‚úèÔ∏è</h1>
        <div class="underline"></div>
        <p>Let's compute 2¬π‚Å∞ = 1024 step by step!</p>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button class="control-btn" id="btnReset">‚èÆÔ∏è Reset</button>
        <button class="control-btn" id="btnPrev">‚óÄÔ∏è Back</button>
        <button class="control-btn play" id="btnPlay">‚ñ∂Ô∏è Play</button>
        <button class="control-btn" id="btnNext">Next ‚ñ∂Ô∏è</button>
      </div>

      <!-- Step indicator -->
      <div class="step-indicator" id="stepIndicator"></div>

      <!-- Section 1: The Key Idea -->
      <div class="section" id="section1">
        <h2 class="section-title">
          <span class="emoji">üîë</span> The Key Idea: Binary Decomposition
        </h2>

        <div class="binary-breakdown">
          <div class="equation-row">
            <span>n =</span>
            <div class="number-box">10</div>
            <span>in binary is</span>
            <div class="binary-display">
              <div class="bit">
                <div class="bit-value" id="bit3">1</div>
                <div class="bit-power">2¬≥=8</div>
              </div>
              <div class="bit">
                <div class="bit-value" id="bit2">0</div>
                <div class="bit-power">2¬≤=4</div>
              </div>
              <div class="bit">
                <div class="bit-value" id="bit1">1</div>
                <div class="bit-power">2¬π=2</div>
              </div>
              <div class="bit">
                <div class="bit-value" id="bit0">0</div>
                <div class="bit-power">2‚Å∞=1</div>
              </div>
            </div>
          </div>

          <div class="arrow-down">‚¨áÔ∏è</div>

          <div class="power-decomposition" id="powerDecomp">
            <span>x¬π‚Å∞ =</span>
            <span class="power-term" id="term8">x‚Å∏</span>
            <span>√ó</span>
            <span class="power-term" id="term4">x‚Å¥</span>
            <span>√ó</span>
            <span class="power-term" id="term2">x¬≤</span>
            <span>√ó</span>
            <span class="power-term" id="term1">x¬π</span>
          </div>
        </div>

        <div class="insight-box">
          <p>
            <strong>The Magic:</strong> Instead of computing x √ó x √ó x √ó ... (10
            times), we only need x¬≤ and x‚Å∏! We skip the powers where the bit is
            0! üöÄ
          </p>
        </div>
      </div>

      <!-- Section 2: Iteration Trace -->
      <div class="section" id="section2">
        <h2 class="section-title">
          <span class="emoji">üìä</span> Iteration Trace: x = 2, n = 10
        </h2>

        <table class="iteration-table">
          <thead>
            <tr>
              <th>Step</th>
              <th>Bit (n % 2)</th>
              <th>Position (2^i)</th>
              <th>Include?</th>
              <th>Current Power</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody id="iterationBody"></tbody>
        </table>

        <div class="state-display">
          <div class="state-box result">
            <div class="state-label">result</div>
            <div class="state-value" id="stateResult">1</div>
          </div>
          <div class="state-box current">
            <div class="state-label">current_product</div>
            <div class="state-value" id="stateCurrent">2</div>
          </div>
          <div class="state-box n">
            <div class="state-label">N (remaining)</div>
            <div class="state-value" id="stateN">10</div>
          </div>
        </div>

        <div class="final-result" id="finalResult">
          <div class="label">üéâ Final Answer üéâ</div>
          <div class="value">2¬π‚Å∞ = 1024</div>
          <div class="calculation">x¬≤ √ó x‚Å∏ = 4 √ó 256 = 1024</div>
        </div>
      </div>

      <!-- Section 3: The Algorithm -->
      <div class="section" id="section3">
        <h2 class="section-title">
          <span class="emoji">üíª</span> The Algorithm
        </h2>

        <div class="pseudocode">
          <pre id="codeDisplay"></pre>
        </div>

        <div class="complexity-stats">
          <div class="stat">
            <div class="stat-icon">‚è±Ô∏è</div>
            <div class="stat-value">O(log n)</div>
            <div class="stat-label">Time</div>
          </div>
          <div class="stat">
            <div class="stat-icon">üíæ</div>
            <div class="stat-value">O(1)</div>
            <div class="stat-label">Space</div>
          </div>
          <div class="stat">
            <div class="stat-icon">üîÑ</div>
            <div class="stat-value">4 iterations</div>
            <div class="stat-label">for n=10</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // State
      let currentStep = 0;
      let isPlaying = false;
      let playInterval = null;
      const totalSteps = 6;

      // Iteration data for x=2, n=10
      const iterations = [
        {
          step: 0,
          bit: "-",
          n: 10,
          nBinary: "1010",
          position: "-",
          include: "Start",
          current: 2,
          result: 1,
          explanation: "Initialize: result = 1, current = x = 2",
        },
        {
          step: 1,
          bit: 0,
          n: 10,
          nBinary: "1010",
          position: "2‚Å∞=1",
          include: "No",
          current: 2,
          next: 4,
          result: 1,
          explanation: "Bit is 0 ‚Üí skip. Square current: 2¬≤ = 4",
        },
        {
          step: 2,
          bit: 1,
          n: 5,
          nBinary: "101",
          position: "2¬π=2",
          include: "Yes ‚úì",
          current: 4,
          next: 16,
          result: 4,
          explanation: "Bit is 1 ‚Üí result √ó 4 = 4. Square: 4¬≤ = 16",
        },
        {
          step: 3,
          bit: 0,
          n: 2,
          nBinary: "10",
          position: "2¬≤=4",
          include: "No",
          current: 16,
          next: 256,
          result: 4,
          explanation: "Bit is 0 ‚Üí skip. Square: 16¬≤ = 256",
        },
        {
          step: 4,
          bit: 1,
          n: 1,
          nBinary: "1",
          position: "2¬≥=8",
          include: "Yes ‚úì",
          current: 256,
          next: "-",
          result: 1024,
          explanation: "Bit is 1 ‚Üí result √ó 256 = 1024. Done!",
        },
      ];

      // Code lines
      const codeLines = [
        { text: '<span class="keyword">function</span> pow(x, n):', indent: 0 },
        { text: "    result = 1", indent: 1 },
        {
          text: '    current_product = x    <span class="comment"># x¬π, x¬≤, x‚Å¥, x‚Å∏...</span>',
          indent: 1,
        },
        { text: "", indent: 0 },
        { text: '    <span class="keyword">while</span> N > 0:', indent: 1 },
        {
          text: '        <span class="keyword">if</span> N % 2 == 1:              <span class="comment"># If bit is 1</span>',
          indent: 2,
          highlight: [2, 4],
        },
        {
          text: "            result = result √ó current_product",
          indent: 3,
          highlight: [2, 4],
        },
        { text: "", indent: 0 },
        {
          text: '        current_product = current_product¬≤  <span class="comment"># Square</span>',
          indent: 2,
        },
        {
          text: '        N = N √∑ 2                          <span class="comment"># Shift right</span>',
          indent: 2,
        },
        { text: "", indent: 0 },
        { text: '    <span class="keyword">return</span> result', indent: 1 },
      ];

      // DOM elements
      const btnReset = document.getElementById("btnReset");
      const btnPrev = document.getElementById("btnPrev");
      const btnPlay = document.getElementById("btnPlay");
      const btnNext = document.getElementById("btnNext");
      const stepIndicator = document.getElementById("stepIndicator");
      const iterationBody = document.getElementById("iterationBody");
      const stateResult = document.getElementById("stateResult");
      const stateCurrent = document.getElementById("stateCurrent");
      const stateN = document.getElementById("stateN");
      const finalResult = document.getElementById("finalResult");
      const codeDisplay = document.getElementById("codeDisplay");

      // Initialize
      function init() {
        renderStepIndicator();
        renderCode();
        render();
      }

      function renderStepIndicator() {
        let html = "";
        for (let i = 0; i <= totalSteps; i++) {
          let cls = "pending";
          if (i < currentStep) cls = "complete";
          else if (i === currentStep) cls = "active";
          html += `<div class="step-dot ${cls}">${i}</div>`;
        }
        stepIndicator.innerHTML = html;
      }

      function renderCode() {
        let html = "";
        codeLines.forEach((line, idx) => {
          let lineClass = "line";
          // Highlight lines 5-6 (if statement) during steps 2 and 4
          if (
            (currentStep === 2 || currentStep === 4) &&
            (idx === 5 || idx === 6)
          ) {
            lineClass += " active";
          }
          html += `<span class="${lineClass}">${line.text}</span>\n`;
        });
        codeDisplay.innerHTML = html;
      }

      function renderBinaryHighlight() {
        const bits = ["bit0", "bit1", "bit2", "bit3"];
        const bitClasses = ["zero", "one", "zero", "one"]; // 0, 1, 0, 1 for 1010

        bits.forEach((id, idx) => {
          const el = document.getElementById(id);
          el.className = "bit-value " + bitClasses[idx];

          // Highlight current bit being processed
          if (currentStep > 0 && currentStep <= 4 && idx === currentStep - 1) {
            el.classList.add("active");
          }
        });
      }

      function renderPowerDecomposition() {
        const terms = [
          { id: "term1", included: false },
          { id: "term2", included: true },
          { id: "term4", included: false },
          { id: "term8", included: true },
        ];

        terms.forEach((term) => {
          const el = document.getElementById(term.id);
          if (currentStep >= 1) {
            el.className =
              "power-term " + (term.included ? "included" : "excluded");
          } else {
            el.className = "power-term";
          }
        });
      }

      function renderIterationTable() {
        let html = "";

        iterations.forEach((iter, idx) => {
          let rowClass = "pending";
          if (idx < currentStep) rowClass = "complete";
          else if (idx === currentStep) rowClass = "active";

          if (idx > currentStep) {
            html += `
            <tr class="${rowClass}">
              <td>?</td>
              <td>?</td>
              <td>?</td>
              <td>?</td>
              <td>?</td>
              <td>?</td>
            </tr>
          `;
          } else {
            const includeClass = iter.include.includes("Yes")
              ? "include-yes"
              : "include-no";
            const resultDisplay = iter.include.includes("Yes")
              ? `<span class="result-update">${iter.result}</span>`
              : iter.result;

            html += `
            <tr class="${rowClass}">
              <td>${iter.step}</td>
              <td>${iter.bit}</td>
              <td>${iter.position}</td>
              <td class="${includeClass}">${iter.include}</td>
              <td>x = ${iter.current}</td>
              <td>${resultDisplay}</td>
            </tr>
          `;
          }
        });

        iterationBody.innerHTML = html;
      }

      function renderState() {
        if (currentStep === 0) {
          stateResult.textContent = "1";
          stateCurrent.textContent = "2";
          stateN.textContent = "10";
        } else if (currentStep <= iterations.length - 1) {
          const iter = iterations[currentStep];
          stateResult.textContent = iter.result;
          stateCurrent.textContent =
            iter.next !== "-" ? iter.next : iter.current;

          // Show remaining N
          const remainingN = [10, 5, 2, 1, 0];
          stateN.textContent = remainingN[currentStep] || "0";
        }
      }

      function renderFinalResult() {
        if (currentStep >= totalSteps) {
          finalResult.classList.add("visible");
        } else {
          finalResult.classList.remove("visible");
        }
      }

      function render() {
        renderStepIndicator();
        renderBinaryHighlight();
        renderPowerDecomposition();
        renderIterationTable();
        renderState();
        renderFinalResult();
        renderCode();
      }

      function nextStep() {
        if (currentStep < totalSteps) {
          currentStep++;
          render();
        } else {
          stopPlaying();
        }
      }

      function prevStep() {
        if (currentStep > 0) {
          currentStep--;
          render();
        }
      }

      function reset() {
        stopPlaying();
        currentStep = 0;
        render();
      }

      function startPlaying() {
        isPlaying = true;
        btnPlay.textContent = "‚è∏Ô∏è Pause";
        btnPlay.classList.remove("play");

        playInterval = setInterval(() => {
          if (currentStep >= totalSteps) {
            stopPlaying();
            return;
          }
          nextStep();
        }, 1500);
      }

      function stopPlaying() {
        isPlaying = false;
        btnPlay.textContent = "‚ñ∂Ô∏è Play";
        btnPlay.classList.add("play");

        if (playInterval) {
          clearInterval(playInterval);
          playInterval = null;
        }
      }

      function togglePlay() {
        if (isPlaying) {
          stopPlaying();
        } else {
          if (currentStep >= totalSteps) {
            currentStep = 0;
            render();
          }
          startPlaying();
        }
      }

      // Event listeners
      btnReset.addEventListener("click", reset);
      btnPrev.addEventListener("click", prevStep);
      btnNext.addEventListener("click", nextStep);
      btnPlay.addEventListener("click", togglePlay);

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowRight") nextStep();
        if (e.key === "ArrowLeft") prevStep();
        if (e.key === " ") {
          e.preventDefault();
          togglePlay();
        }
        if (e.key === "r") reset();
      });

      // Initialize on load
      init();
    </script>
  </body>
</html>
