<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Remove Duplicates II - Optimal Solution Visualization</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=Patrick+Hand&family=Kalam:wght@400;700&family=Shadows+Into+Light&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Kalam", cursive;
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 50%,
          #f093fb 100%
        );
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      .notebook {
        background: #fffef0;
        background-image: linear-gradient(#e8e8e8 1px, transparent 1px),
          linear-gradient(
            90deg,
            transparent 60px,
            #ffcccc 60px,
            #ffcccc 62px,
            transparent 62px
          );
        background-size: 100% 28px, 100% 100%;
        border-radius: 5px;
        padding: 40px 40px 40px 80px;
        width: 100%;
        max-width: 1200px;
        min-height: 800px;
        position: relative;
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1),
          5px 5px 20px rgba(0, 0, 0, 0.2),
          -2px -2px 10px rgba(255, 255, 255, 0.3);
      }

      .notebook::before {
        content: "";
        position: absolute;
        top: 0;
        left: 55px;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #ff9999, #ffcccc);
        border-radius: 2px;
      }

      .spiral-holes {
        position: absolute;
        left: 15px;
        top: 30px;
        bottom: 30px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .hole {
        width: 20px;
        height: 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 50%;
        box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .title {
        font-family: "Shadows Into Light", cursive;
        font-size: 2.2rem;
        color: #333;
        text-align: center;
        margin-bottom: 5px;
        position: relative;
      }

      .title::after {
        content: "";
        position: absolute;
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        height: 3px;
        background: linear-gradient(
          90deg,
          transparent,
          #ff6b6b,
          #feca57,
          #48dbfb,
          #ff6b6b,
          transparent
        );
        border-radius: 2px;
      }

      .subtitle {
        font-family: "Kalam", cursive;
        font-size: 1.2rem;
        color: #666;
        text-align: center;
        margin-bottom: 15px;
        margin-top: 15px;
      }

      .optimal-badge {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
      }

      .badge {
        font-family: "Patrick Hand", cursive;
        font-size: 1rem;
        padding: 5px 15px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .badge-optimal {
        background: linear-gradient(135deg, #00b894, #00cec9);
        color: white;
        box-shadow: 0 3px 10px rgba(0, 184, 148, 0.3);
      }

      .badge-time {
        background: rgba(46, 213, 115, 0.2);
        color: #2ed573;
        border: 1px solid #2ed573;
      }

      .badge-space {
        background: rgba(255, 107, 129, 0.2);
        color: #ff6b81;
        border: 1px solid #ff6b81;
      }

      .content-area {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .section {
        background: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        padding: 15px 20px;
        border: 2px solid #eee;
        box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.05);
      }

      .section-header {
        font-family: "Patrick Hand", cursive;
        font-size: 1.15rem;
        color: #5f27cd;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 2px dashed #ddd;
        padding-bottom: 8px;
      }

      /* Linked List */
      .list-visualization {
        display: flex;
        align-items: flex-start;
        justify-content: center;
        min-height: 100px;
        padding: 10px 0;
      }

      .node-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 2px;
      }

      .pointer-tags {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 45px;
        gap: 2px;
        margin-bottom: 4px;
      }

      .tag {
        font-family: "Patrick Hand", cursive;
        font-size: 0.8rem;
        padding: 2px 10px;
        border-radius: 10px;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.3s ease;
      }

      .tag.visible {
        opacity: 1;
        transform: scale(1);
      }

      .tag-prev {
        background: #ff6b6b;
        color: white;
      }

      .tag-current {
        background: #4834d4;
        color: white;
      }

      .tag-checking {
        background: #feca57;
        color: #333;
      }

      .node-cell {
        display: flex;
        align-items: center;
      }

      .node-box {
        width: 50px;
        height: 50px;
        border: 3px solid #333;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Caveat", cursive;
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
        background: white;
        transition: all 0.35s ease;
        position: relative;
      }

      .node-box.dummy-node {
        background: #f8f9fa;
        border-color: #aaa;
        color: #888;
        font-size: 1.3rem;
      }

      .node-box.prev-highlight {
        border-color: #ff6b6b;
        box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.3),
          0 4px 15px rgba(255, 107, 107, 0.4);
      }

      .node-box.current-highlight {
        border-color: #4834d4;
        box-shadow: 0 0 0 3px rgba(72, 52, 212, 0.3),
          0 4px 15px rgba(72, 52, 212, 0.4);
        transform: scale(1.05);
      }

      .node-box.checking-next {
        border-color: #feca57;
        box-shadow: 0 0 0 3px rgba(254, 202, 87, 0.4);
      }

      .node-box.duplicate-mark {
        background: #ffe0e0;
        border-color: #e74c3c;
        animation: wiggle 0.5s ease;
      }

      .node-box.safe-zone {
        background: #d5f5e3;
        border-color: #27ae60;
      }

      .node-box.being-removed {
        opacity: 0.4;
        border-style: dashed;
        text-decoration: line-through;
        transform: scale(0.9);
      }

      .node-box.final-kept {
        background: linear-gradient(135deg, #d5f5e3, #abebc6);
        border-color: #27ae60;
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
      }

      @keyframes wiggle {
        0%,
        100% {
          transform: rotate(0deg);
        }
        25% {
          transform: rotate(-3deg);
        }
        75% {
          transform: rotate(3deg);
        }
      }

      .arrow-connector {
        font-size: 1.2rem;
        color: #666;
        margin: 0 1px;
        transition: all 0.3s ease;
      }

      .arrow-connector.broken {
        color: #e74c3c;
        opacity: 0.3;
      }

      .arrow-connector.rewired {
        color: #27ae60;
        font-weight: bold;
      }

      .null-indicator {
        font-family: "Kalam", cursive;
        font-size: 1rem;
        color: #999;
        padding: 10px;
        align-self: center;
      }

      /* Variable Panel */
      .var-panel {
        display: flex;
        justify-content: center;
        gap: 25px;
        flex-wrap: wrap;
      }

      .var-box {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px solid #eee;
      }

      .var-name {
        font-family: "Patrick Hand", cursive;
        font-size: 1rem;
        color: #666;
      }

      .var-value {
        font-family: "Caveat", cursive;
        font-size: 1.4rem;
        font-weight: 700;
        padding: 4px 12px;
        border-radius: 6px;
        min-width: 45px;
        text-align: center;
      }

      .var-prev {
        background: rgba(255, 107, 107, 0.2);
        color: #ff6b6b;
        border: 2px solid #ff6b6b;
      }

      .var-current {
        background: rgba(72, 52, 212, 0.2);
        color: #4834d4;
        border: 2px solid #4834d4;
      }

      .var-dupval {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
        border: 2px solid #e74c3c;
      }

      /* Explanation Box */
      .explanation-box {
        background: linear-gradient(135deg, #fff9e6, #fff3cd);
        border-radius: 10px;
        padding: 15px 20px;
        border-left: 5px solid #ffc107;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.05);
      }

      .explanation-text {
        font-family: "Kalam", cursive;
        font-size: 1.1rem;
        color: #333;
        line-height: 1.7;
      }

      .explanation-text .hl-prev {
        color: #ff6b6b;
        font-weight: 700;
      }

      .explanation-text .hl-current {
        color: #4834d4;
        font-weight: 700;
      }

      .explanation-text .hl-value {
        color: #0984e3;
        font-weight: 700;
      }

      .explanation-text .hl-action {
        color: #00b894;
        font-weight: 700;
      }

      .explanation-text .hl-danger {
        color: #e74c3c;
        font-weight: 700;
      }

      /* Code Section */
      .code-section {
        background: #2d3436;
        border-radius: 8px;
        padding: 12px 15px;
        font-family: "Courier New", monospace;
        font-size: 0.85rem;
        overflow-x: auto;
      }

      .code-row {
        padding: 3px 8px;
        color: rgba(255, 255, 255, 0.5);
        border-radius: 4px;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .code-row.highlighted {
        background: rgba(116, 185, 255, 0.2);
        color: #74b9ff;
        border-left: 3px solid #74b9ff;
      }

      .code-row .kw {
        color: #fd79a8;
      }
      .code-row .vr {
        color: #81ecec;
      }
      .code-row .cm {
        color: #636e72;
        font-style: italic;
      }
      .code-row .op {
        color: #ffeaa7;
      }

      /* Invariant Panel */
      .invariant-panel {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        border-radius: 8px;
        padding: 12px 18px;
        border: 2px solid #81c784;
      }

      .invariant-title {
        font-family: "Patrick Hand", cursive;
        font-size: 1rem;
        color: #2e7d32;
        margin-bottom: 6px;
        font-weight: 600;
      }

      .invariant-text {
        font-family: "Kalam", cursive;
        font-size: 0.95rem;
        color: #1b5e20;
      }

      /* Progress */
      .progress-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 15px;
      }

      .progress-label {
        font-family: "Patrick Hand", cursive;
        font-size: 0.95rem;
        color: #666;
        min-width: 60px;
      }

      .progress-bar {
        flex: 1;
        height: 8px;
        background: #eee;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .step-num {
        font-family: "Patrick Hand", cursive;
        font-size: 0.95rem;
        color: #764ba2;
        min-width: 55px;
        text-align: right;
      }

      /* Controls */
      .controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 18px;
        flex-wrap: wrap;
      }

      .ctrl-btn {
        font-family: "Patrick Hand", cursive;
        font-size: 1rem;
        padding: 10px 22px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.25s ease;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .ctrl-btn:hover:not(:disabled) {
        transform: translateY(-2px);
      }

      .ctrl-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .btn-prev-ctrl {
        background: linear-gradient(135deg, #a29bfe, #6c5ce7);
        color: white;
        box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
      }

      .btn-play-ctrl {
        background: linear-gradient(135deg, #55efc4, #00b894);
        color: white;
        box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);
      }

      .btn-next-ctrl {
        background: linear-gradient(135deg, #a29bfe, #6c5ce7);
        color: white;
        box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
      }

      .btn-reset-ctrl {
        background: linear-gradient(135deg, #ff7675, #d63031);
        color: white;
        box-shadow: 0 4px 12px rgba(214, 48, 49, 0.3);
      }

      /* Legend */
      .legend {
        display: flex;
        justify-content: center;
        gap: 18px;
        margin-top: 12px;
        flex-wrap: wrap;
      }

      .legend-entry {
        display: flex;
        align-items: center;
        gap: 6px;
        font-family: "Patrick Hand", cursive;
        font-size: 0.9rem;
        color: #666;
      }

      .legend-icon {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 2px solid;
      }

      .legend-prev-icon {
        border-color: #ff6b6b;
        box-shadow: 0 0 6px rgba(255, 107, 107, 0.4);
      }

      .legend-current-icon {
        border-color: #4834d4;
        box-shadow: 0 0 6px rgba(72, 52, 212, 0.4);
      }

      .legend-safe-icon {
        border-color: #27ae60;
        background: rgba(39, 174, 96, 0.3);
      }

      .legend-removed-icon {
        border-color: #e74c3c;
        border-style: dashed;
        opacity: 0.5;
      }

      /* Keyboard */
      .keyboard-info {
        text-align: center;
        margin-top: 10px;
        font-family: "Patrick Hand", cursive;
        font-size: 0.85rem;
        color: #999;
      }

      .kbd {
        display: inline-block;
        background: #f0f0f0;
        padding: 2px 7px;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin: 0 2px;
        font-size: 0.8rem;
      }

      /* Responsive */
      @media (max-width: 900px) {
        .notebook {
          padding: 30px 25px 30px 70px;
        }

        .title {
          font-size: 1.7rem;
        }

        .node-box {
          width: 40px;
          height: 40px;
          font-size: 1.4rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="notebook">
      <div class="spiral-holes">
        <div class="hole"></div>
        <div class="hole"></div>
        <div class="hole"></div>
        <div class="hole"></div>
        <div class="hole"></div>
        <div class="hole"></div>
        <div class="hole"></div>
        <div class="hole"></div>
        <div class="hole"></div>
        <div class="hole"></div>
      </div>

      <h1 class="title">Remove Duplicates from Sorted List II</h1>
      <p class="subtitle">
        üèÜ Optimal Solution ‚Äî Clean & Efficient Implementation
      </p>

      <div class="optimal-badge">
        <span class="badge badge-optimal">‚≠ê OPTIMAL</span>
        <span class="badge badge-time">‚è± O(n) Time</span>
        <span class="badge badge-space">üíæ O(1) Space</span>
      </div>

      <div class="content-area">
        <!-- Linked List Visualization -->
        <div class="section">
          <div class="section-header">
            <span>üîó</span> Linked List ‚Äî Input: [1, 2, 3, 3, 4, 4, 5]
          </div>
          <div class="list-visualization" id="listViz"></div>
        </div>

        <!-- Variables Panel -->
        <div class="section">
          <div class="section-header"><span>üìä</span> Variable States</div>
          <div class="var-panel">
            <div class="var-box">
              <span class="var-name">prev ‚Üí</span>
              <span class="var-value var-prev" id="varPrev">dummy</span>
            </div>
            <div class="var-box">
              <span class="var-name">current (prev.next) ‚Üí</span>
              <span class="var-value var-current" id="varCurrent">1</span>
            </div>
            <div class="var-box">
              <span class="var-name">duplicateVal ‚Üí</span>
              <span class="var-value var-dupval" id="varDupVal">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Explanation -->
        <div class="explanation-box">
          <div class="explanation-text" id="explainText">
            Click <span class="hl-action">Play</span> or
            <span class="hl-action">Next</span> to begin stepping through the
            optimal algorithm!
          </div>
        </div>

        <!-- Code -->
        <div class="code-section">
          <div class="code-row" id="c1">
            <span class="kw">while</span> (<span class="vr">prev.next</span>
            <span class="op">!==</span> <span class="kw">null</span>) {
          </div>
          <div class="code-row" id="c2">
            <span class="vr">current</span> <span class="op">=</span>
            <span class="vr">prev.next</span>;
          </div>
          <div class="code-row" id="c3">
            <span class="kw">if</span> (<span class="vr">current.next</span>
            <span class="op">&&</span> <span class="vr">current.val</span>
            <span class="op">===</span>
            <span class="vr">current.next.val</span>) {
            <span class="cm">// dup!</span>
          </div>
          <div class="code-row" id="c4">
            <span class="vr">duplicateVal</span> <span class="op">=</span>
            <span class="vr">current.val</span>;
          </div>
          <div class="code-row" id="c5">
            <span class="kw">while</span> (<span class="vr">prev.next</span>
            <span class="op">&&</span> <span class="vr">prev.next.val</span>
            <span class="op">===</span> <span class="vr">duplicateVal</span>)
            <span class="vr">prev.next</span> <span class="op">=</span>
            <span class="vr">prev.next.next</span>;
          </div>
          <div class="code-row" id="c6">
            } <span class="kw">else</span> { <span class="vr">prev</span>
            <span class="op">=</span> <span class="vr">prev.next</span>; }
            <span class="cm">// unique</span>
          </div>
          <div class="code-row" id="c7">}</div>
        </div>

        <!-- Invariant -->
        <div class="invariant-panel">
          <div class="invariant-title">üîê Loop Invariant</div>
          <div class="invariant-text" id="invariantText">
            All nodes from dummy.next to prev (inclusive) are confirmed unique
            values.
          </div>
        </div>
      </div>

      <!-- Progress -->
      <div class="progress-row">
        <span class="progress-label">Progress:</span>
        <div class="progress-bar">
          <div class="progress-fill" id="progFill"></div>
        </div>
        <span class="step-num" id="stepNum">0 / 0</span>
      </div>

      <!-- Controls -->
      <div class="controls">
        <button class="ctrl-btn btn-prev-ctrl" id="btnPrev" onclick="goPrev()">
          ‚óÄ Prev
        </button>
        <button
          class="ctrl-btn btn-play-ctrl"
          id="btnPlay"
          onclick="togglePlay()"
        >
          ‚ñ∂ Play
        </button>
        <button class="ctrl-btn btn-next-ctrl" id="btnNext" onclick="goNext()">
          Next ‚ñ∂
        </button>
        <button
          class="ctrl-btn btn-reset-ctrl"
          id="btnReset"
          onclick="doReset()"
        >
          ‚Ü∫ Reset
        </button>
      </div>

      <!-- Legend -->
      <div class="legend">
        <div class="legend-entry">
          <div class="legend-icon legend-prev-icon"></div>
          <span>prev</span>
        </div>
        <div class="legend-entry">
          <div class="legend-icon legend-current-icon"></div>
          <span>current</span>
        </div>
        <div class="legend-entry">
          <div class="legend-icon legend-safe-icon"></div>
          <span>Safe zone</span>
        </div>
        <div class="legend-entry">
          <div class="legend-icon legend-removed-icon"></div>
          <span>Removed</span>
        </div>
      </div>

      <!-- Keyboard -->
      <div class="keyboard-info">
        <span class="kbd">‚Üê</span> Prev <span class="kbd">‚Üí</span> Next
        <span class="kbd">Space</span> Play/Pause
        <span class="kbd">R</span> Reset
      </div>
    </div>

    <script>
      // Data: D=dummy(0), then 1,2,3,3,4,4,5
      const nodes = ["D", 1, 2, 3, 3, 4, 4, 5];

      let step = 0;
      let playing = false;
      let timer = null;

      const allSteps = buildSteps();

      function buildSteps() {
        const S = [];

        // Step 0: Initial setup
        S.push({
          prevIdx: 0,
          currentIdx: 1,
          checkingIdx: -1,
          dupVal: null,
          removed: [],
          safe: [],
          text: `<span class="hl-action">Initialize:</span> Create a <span class="hl-value">dummy</span> node pointing to head. <span class="hl-prev">prev</span> = dummy. We iterate while <span class="hl-current">prev.next</span> is not null.`,
          code: [],
          invariant: `Safe zone is empty. prev points to dummy.`,
        });

        // Step 1: Check current = 1
        S.push({
          prevIdx: 0,
          currentIdx: 1,
          checkingIdx: 2,
          dupVal: null,
          removed: [],
          safe: [],
          text: `<span class="hl-current">current = prev.next = 1</span>. Compare: Is <span class="hl-value">current.val (1)</span> === <span class="hl-value">current.next.val (2)</span>? <span class="hl-action">NO!</span>`,
          code: ["c1", "c2", "c3"],
          invariant: `Checking if node 1 is duplicate...`,
        });

        // Step 2: 1 is unique, advance prev
        S.push({
          prevIdx: 1,
          currentIdx: 1,
          checkingIdx: -1,
          dupVal: null,
          removed: [],
          safe: [1],
          text: `<span class="hl-action">UNIQUE!</span> Advance <span class="hl-prev">prev = prev.next</span>. Node <span class="hl-value">1</span> is now in the safe zone. ‚úì`,
          code: ["c6"],
          invariant: `Safe zone: [1]. All nodes up to prev are unique.`,
        });

        // Step 3: Check current = 2
        S.push({
          prevIdx: 1,
          currentIdx: 2,
          checkingIdx: 3,
          dupVal: null,
          removed: [],
          safe: [1],
          text: `<span class="hl-current">current = prev.next = 2</span>. Compare: Is <span class="hl-value">current.val (2)</span> === <span class="hl-value">current.next.val (3)</span>? <span class="hl-action">NO!</span>`,
          code: ["c1", "c2", "c3"],
          invariant: `Checking if node 2 is duplicate...`,
        });

        // Step 4: 2 is unique, advance prev
        S.push({
          prevIdx: 2,
          currentIdx: 2,
          checkingIdx: -1,
          dupVal: null,
          removed: [],
          safe: [1, 2],
          text: `<span class="hl-action">UNIQUE!</span> Advance <span class="hl-prev">prev = prev.next</span>. Node <span class="hl-value">2</span> joins the safe zone. ‚úì`,
          code: ["c6"],
          invariant: `Safe zone: [1, 2]. Invariant maintained.`,
        });

        // Step 5: Check current = 3 (first)
        S.push({
          prevIdx: 2,
          currentIdx: 3,
          checkingIdx: 4,
          dupVal: null,
          removed: [],
          safe: [1, 2],
          duplicateDetected: [3, 4],
          text: `<span class="hl-current">current = prev.next = 3</span>. Compare: Is <span class="hl-value">current.val (3)</span> === <span class="hl-value">current.next.val (3)</span>? <span class="hl-danger">YES! DUPLICATE!</span> üö®`,
          code: ["c1", "c2", "c3"],
          invariant: `Duplicate detected! Must remove ALL 3s.`,
        });

        // Step 6: Store duplicateVal = 3
        S.push({
          prevIdx: 2,
          currentIdx: 3,
          checkingIdx: -1,
          dupVal: 3,
          removed: [],
          safe: [1, 2],
          duplicateDetected: [3, 4],
          text: `Store <span class="hl-danger">duplicateVal = 3</span>. Now remove ALL nodes with value 3 using inner while loop.`,
          code: ["c4"],
          invariant: `duplicateVal = 3. Will skip all 3s.`,
        });

        // Step 7: Remove first 3
        S.push({
          prevIdx: 2,
          currentIdx: 3,
          checkingIdx: -1,
          dupVal: 3,
          removed: [3],
          safe: [1, 2],
          text: `Inner loop: <span class="hl-prev">prev.next.val (3)</span> === <span class="hl-danger">duplicateVal (3)</span>? YES! Set <span class="hl-prev">prev.next = prev.next.next</span>. First 3 removed!`,
          code: ["c5"],
          invariant: `Removing nodes with value 3...`,
        });

        // Step 8: Remove second 3
        S.push({
          prevIdx: 2,
          currentIdx: 4,
          checkingIdx: -1,
          dupVal: 3,
          removed: [3, 4],
          safe: [1, 2],
          text: `Inner loop: <span class="hl-prev">prev.next.val (3)</span> === <span class="hl-danger">duplicateVal (3)</span>? YES! Set <span class="hl-prev">prev.next = prev.next.next</span>. Second 3 removed!`,
          code: ["c5"],
          invariant: `Removing nodes with value 3...`,
        });

        // Step 9: Inner loop done, prev.next is now 4
        S.push({
          prevIdx: 2,
          currentIdx: 5,
          checkingIdx: -1,
          dupVal: null,
          removed: [3, 4],
          safe: [1, 2],
          text: `Inner loop: <span class="hl-prev">prev.next.val (4)</span> === <span class="hl-danger">duplicateVal (3)</span>? NO! Exit inner loop. Both 3s removed! <span class="hl-prev">prev</span> did NOT move.`,
          code: ["c5"],
          invariant: `All 3s removed. Checking new prev.next...`,
        });

        // Step 10: Check current = 4 (first)
        S.push({
          prevIdx: 2,
          currentIdx: 5,
          checkingIdx: 6,
          dupVal: null,
          removed: [3, 4],
          safe: [1, 2],
          duplicateDetected: [5, 6],
          text: `<span class="hl-current">current = prev.next = 4</span>. Compare: Is <span class="hl-value">current.val (4)</span> === <span class="hl-value">current.next.val (4)</span>? <span class="hl-danger">YES! DUPLICATE!</span> üö®`,
          code: ["c1", "c2", "c3"],
          invariant: `Another duplicate detected!`,
        });

        // Step 11: Store duplicateVal = 4
        S.push({
          prevIdx: 2,
          currentIdx: 5,
          checkingIdx: -1,
          dupVal: 4,
          removed: [3, 4],
          safe: [1, 2],
          duplicateDetected: [5, 6],
          text: `Store <span class="hl-danger">duplicateVal = 4</span>. Now remove ALL nodes with value 4.`,
          code: ["c4"],
          invariant: `duplicateVal = 4. Will skip all 4s.`,
        });

        // Step 12: Remove first 4
        S.push({
          prevIdx: 2,
          currentIdx: 5,
          checkingIdx: -1,
          dupVal: 4,
          removed: [3, 4, 5],
          safe: [1, 2],
          text: `Inner loop: <span class="hl-prev">prev.next.val (4)</span> === <span class="hl-danger">duplicateVal (4)</span>? YES! Set <span class="hl-prev">prev.next = prev.next.next</span>. First 4 removed!`,
          code: ["c5"],
          invariant: `Removing nodes with value 4...`,
        });

        // Step 13: Remove second 4
        S.push({
          prevIdx: 2,
          currentIdx: 6,
          checkingIdx: -1,
          dupVal: 4,
          removed: [3, 4, 5, 6],
          safe: [1, 2],
          text: `Inner loop: <span class="hl-prev">prev.next.val (4)</span> === <span class="hl-danger">duplicateVal (4)</span>? YES! Set <span class="hl-prev">prev.next = prev.next.next</span>. Second 4 removed!`,
          code: ["c5"],
          invariant: `Removing nodes with value 4...`,
        });

        // Step 14: Inner loop done, prev.next is now 5
        S.push({
          prevIdx: 2,
          currentIdx: 7,
          checkingIdx: -1,
          dupVal: null,
          removed: [3, 4, 5, 6],
          safe: [1, 2],
          text: `Inner loop: <span class="hl-prev">prev.next.val (5)</span> === <span class="hl-danger">duplicateVal (4)</span>? NO! Exit inner loop. Both 4s removed!`,
          code: ["c5"],
          invariant: `All 4s removed. Checking new prev.next...`,
        });

        // Step 15: Check current = 5
        S.push({
          prevIdx: 2,
          currentIdx: 7,
          checkingIdx: -1,
          dupVal: null,
          removed: [3, 4, 5, 6],
          safe: [1, 2],
          text: `<span class="hl-current">current = prev.next = 5</span>. <span class="hl-value">current.next</span> is <span class="hl-value">null</span>. No next node to compare! <span class="hl-action">Node 5 is unique!</span>`,
          code: ["c1", "c2", "c3"],
          invariant: `Last node check...`,
        });

        // Step 16: 5 is unique, advance prev
        S.push({
          prevIdx: 7,
          currentIdx: 7,
          checkingIdx: -1,
          dupVal: null,
          removed: [3, 4, 5, 6],
          safe: [1, 2, 7],
          text: `<span class="hl-action">UNIQUE!</span> Advance <span class="hl-prev">prev = prev.next</span>. Node <span class="hl-value">5</span> joins the safe zone. ‚úì`,
          code: ["c6"],
          invariant: `Safe zone: [1, 2, 5]. All unique!`,
        });

        // Step 17: Loop ends
        S.push({
          prevIdx: 7,
          currentIdx: -1,
          checkingIdx: -1,
          dupVal: null,
          removed: [3, 4, 5, 6],
          safe: [1, 2, 7],
          text: `<span class="hl-prev">prev.next</span> is now <span class="hl-value">null</span>. While loop condition fails. <span class="hl-action">Loop terminates!</span>`,
          code: ["c1", "c7"],
          invariant: `Algorithm complete.`,
        });

        // Step 18: Final result
        S.push({
          prevIdx: -1,
          currentIdx: -1,
          checkingIdx: -1,
          dupVal: null,
          removed: [3, 4, 5, 6],
          safe: [1, 2, 7],
          final: true,
          text: `‚úÖ <span class="hl-action">COMPLETE!</span> Return <span class="hl-value">dummy.next</span>. Final result: <span class="hl-action">[1 ‚Üí 2 ‚Üí 5]</span>. All duplicates removed in O(n) time, O(1) space!`,
          code: [],
          invariant: `Result: [1, 2, 5] ‚Äî Only values that appeared exactly once.`,
        });

        return S;
      }

      function render() {
        const s = allSteps[step];

        // Render list
        renderList(s);

        // Update variables
        document.getElementById("varPrev").textContent =
          s.prevIdx === 0 ? "dummy" : s.prevIdx > 0 ? nodes[s.prevIdx] : "‚Äî";
        document.getElementById("varCurrent").textContent =
          s.currentIdx > 0 ? nodes[s.currentIdx] : "null";
        document.getElementById("varDupVal").textContent =
          s.dupVal !== null ? s.dupVal : "‚Äî";

        // Update explanation
        document.getElementById("explainText").innerHTML = s.text;

        // Update code highlighting
        document
          .querySelectorAll(".code-row")
          .forEach((el) => el.classList.remove("highlighted"));
        (s.code || []).forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.add("highlighted");
        });

        // Update invariant
        document.getElementById("invariantText").textContent = s.invariant;

        // Progress
        const pct = (step / (allSteps.length - 1)) * 100;
        document.getElementById("progFill").style.width = pct + "%";
        document.getElementById("stepNum").textContent = `${step} / ${
          allSteps.length - 1
        }`;

        // Buttons
        document.getElementById("btnPrev").disabled = step === 0;
        document.getElementById("btnNext").disabled =
          step === allSteps.length - 1;
        document.getElementById("btnPlay").innerHTML = playing
          ? "‚è∏ Pause"
          : "‚ñ∂ Play";
      }

      function renderList(s) {
        const container = document.getElementById("listViz");
        container.innerHTML = "";

        nodes.forEach((val, idx) => {
          const wrapper = document.createElement("div");
          wrapper.className = "node-wrapper";

          // Tags
          const tags = document.createElement("div");
          tags.className = "pointer-tags";

          if (idx === s.prevIdx) {
            const t = document.createElement("div");
            t.className = "tag tag-prev visible";
            t.textContent = "prev";
            tags.appendChild(t);
          }

          if (idx === s.currentIdx && idx !== s.prevIdx) {
            const t = document.createElement("div");
            t.className = "tag tag-current visible";
            t.textContent = "current";
            tags.appendChild(t);
          }

          if (idx === s.checkingIdx) {
            const t = document.createElement("div");
            t.className = "tag tag-checking visible";
            t.textContent = "next?";
            tags.appendChild(t);
          }

          wrapper.appendChild(tags);

          // Node cell
          const cell = document.createElement("div");
          cell.className = "node-cell";

          const box = document.createElement("div");
          box.className = "node-box";

          if (val === "D") {
            box.classList.add("dummy-node");
            box.textContent = "D(0)";
          } else {
            box.textContent = val;
          }

          // Apply classes
          if (idx === s.prevIdx) box.classList.add("prev-highlight");
          if (idx === s.currentIdx && idx !== s.prevIdx)
            box.classList.add("current-highlight");
          if (idx === s.checkingIdx) box.classList.add("checking-next");

          if (s.duplicateDetected && s.duplicateDetected.includes(idx)) {
            box.classList.add("duplicate-mark");
          }

          if (s.safe && s.safe.includes(idx)) {
            box.classList.add("safe-zone");
          }

          if (s.removed && s.removed.includes(idx)) {
            box.classList.add("being-removed");
          }

          if (s.final && s.safe && s.safe.includes(idx)) {
            box.classList.add("final-kept");
          }

          cell.appendChild(box);

          // Arrow
          if (idx < nodes.length - 1) {
            const arrow = document.createElement("span");
            arrow.className = "arrow-connector";
            arrow.textContent = "‚Üí";

            // Check if connection is broken
            if (s.removed && s.removed.includes(idx)) {
              arrow.classList.add("broken");
            }

            // Check for rewired connections
            if (s.removed && s.removed.length > 0) {
              // Find if this is a "live" connection
              const nextLiveIdx = findNextLive(idx, s.removed);
              if (nextLiveIdx !== idx + 1 && !s.removed.includes(idx)) {
                arrow.classList.add("rewired");
              }
            }

            cell.appendChild(arrow);
          }

          wrapper.appendChild(cell);
          container.appendChild(wrapper);
        });

        // Null indicator
        const nullInd = document.createElement("div");
        nullInd.className = "null-indicator";
        nullInd.textContent = "‚Üí null";
        container.appendChild(nullInd);
      }

      function findNextLive(idx, removed) {
        for (let i = idx + 1; i < nodes.length; i++) {
          if (!removed.includes(i)) return i;
        }
        return -1;
      }

      function goNext() {
        if (step < allSteps.length - 1) {
          step++;
          render();
        } else if (playing) {
          stopPlay();
        }
      }

      function goPrev() {
        if (step > 0) {
          step--;
          render();
        }
      }

      function togglePlay() {
        if (playing) {
          stopPlay();
        } else {
          startPlay();
        }
      }

      function startPlay() {
        playing = true;
        timer = setInterval(() => {
          if (step < allSteps.length - 1) {
            goNext();
          } else {
            stopPlay();
          }
        }, 2000);
        render();
      }

      function stopPlay() {
        playing = false;
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
        render();
      }

      function doReset() {
        stopPlay();
        step = 0;
        render();
      }

      // Keyboard
      document.addEventListener("keydown", (e) => {
        switch (e.key) {
          case "ArrowRight":
            goNext();
            break;
          case "ArrowLeft":
            goPrev();
            break;
          case " ":
            e.preventDefault();
            togglePlay();
            break;
          case "r":
          case "R":
            doReset();
            break;
        }
      });

      // Init
      render();
    </script>
  </body>
</html>
