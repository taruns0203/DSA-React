<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Merge K Sorted Lists - Sequential Merge Approach</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=Patrick+Hand&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Patrick Hand", cursive;
        background: #f5f5f0;
        min-height: 100vh;
        padding: 20px;
      }

      .whiteboard {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1),
          inset 0 0 100px rgba(0, 0, 0, 0.02);
        max-width: 1300px;
        margin: 0 auto;
        padding: 30px;
        position: relative;
        border: 12px solid #8b7355;
      }

      .whiteboard::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          90deg,
          transparent 0%,
          transparent 50%,
          rgba(200, 200, 200, 0.03) 50%,
          rgba(200, 200, 200, 0.03) 100%
        );
        background-size: 4px 4px;
        pointer-events: none;
      }

      h1 {
        font-family: "Caveat", cursive;
        font-size: 2.8rem;
        color: #9c4221;
        text-align: center;
        margin-bottom: 10px;
        text-decoration: underline;
        text-decoration-style: wavy;
        text-decoration-color: #38a169;
        text-underline-offset: 8px;
      }

      .subtitle {
        text-align: center;
        font-size: 1.4rem;
        color: #666;
        margin-bottom: 25px;
      }

      .merge-round-indicator {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }

      .round-badge {
        padding: 8px 18px;
        border-radius: 20px;
        font-size: 1.1rem;
        border: 3px dashed #ccc;
        color: #999;
        transition: all 0.3s ease;
      }

      .round-badge.active {
        border-color: #ed8936;
        background: #fffaf0;
        color: #c05621;
        border-style: solid;
        transform: scale(1.08);
        box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
      }

      .round-badge.completed {
        border-color: #9ae6b4;
        background: #c6f6d5;
        color: #22543d;
        border-style: solid;
      }

      .step-counter {
        text-align: center;
        font-family: "Caveat", cursive;
        font-size: 1.5rem;
        color: #718096;
        margin-bottom: 15px;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 28px;
        font-family: "Patrick Hand", cursive;
        font-size: 1.2rem;
        border: 3px solid #333;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #fff;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .btn-primary {
        background: #4299e1;
        color: #fff;
        border-color: #2b6cb0;
      }

      .btn-success {
        background: #48bb78;
        color: #fff;
        border-color: #276749;
      }

      .btn-warning {
        background: #ed8936;
        color: #fff;
        border-color: #c05621;
      }

      .btn-danger {
        background: #fc8181;
        color: #fff;
        border-color: #c53030;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .speed-control {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
      }

      .speed-label {
        font-size: 1.1rem;
        color: #4a5568;
      }

      .speed-slider {
        width: 150px;
        height: 8px;
        -webkit-appearance: none;
        background: #e2e8f0;
        border-radius: 4px;
        outline: none;
      }

      .speed-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background: #ed8936;
        border-radius: 50%;
        cursor: pointer;
      }

      .explanation-box {
        background: #fef5e7;
        border: 3px solid #d69e2e;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        min-height: 100px;
      }

      .explanation-title {
        font-family: "Caveat", cursive;
        font-size: 1.4rem;
        color: #975a16;
        margin-bottom: 10px;
      }

      .explanation-text {
        font-size: 1.15rem;
        color: #744210;
        line-height: 1.6;
      }

      .code-display {
        font-family: "Courier New", monospace;
        background: #2d3748;
        color: #e2e8f0;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 1rem;
      }

      .main-content {
        display: flex;
        flex-direction: column;
        gap: 25px;
      }

      .section {
        background: rgba(255, 255, 255, 0.7);
        border: 3px solid #333;
        border-radius: 12px;
        padding: 20px;
        position: relative;
      }

      .section-title {
        font-family: "Caveat", cursive;
        font-size: 1.6rem;
        color: #2d3748;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e2e8f0;
      }

      .input-lists-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .list-row {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .list-row.being-merged {
        background: #fef3c7;
        border: 2px dashed #d69e2e;
      }

      .list-row.merged-away {
        opacity: 0.3;
        transform: scale(0.95);
      }

      .list-label {
        font-family: "Caveat", cursive;
        font-size: 1.3rem;
        color: #553c9a;
        min-width: 80px;
      }

      .linked-list {
        display: flex;
        align-items: center;
        gap: 5px;
        flex-wrap: wrap;
      }

      .node {
        width: 48px;
        height: 48px;
        border: 3px solid #333;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        font-weight: bold;
        background: #fff;
        position: relative;
        transition: all 0.3s ease;
      }

      .node.pointer-l1 {
        background: #fed7e2;
        border-color: #d53f8c;
        box-shadow: 0 0 15px rgba(213, 63, 140, 0.4);
      }

      .node.pointer-l2 {
        background: #c6f6d5;
        border-color: #38a169;
        box-shadow: 0 0 15px rgba(56, 161, 105, 0.4);
      }

      .node.picked {
        background: #fefcbf;
        border-color: #d69e2e;
        transform: scale(1.1);
      }

      .node.used {
        opacity: 0.4;
        transform: scale(0.85);
      }

      .arrow {
        font-size: 1.6rem;
        color: #666;
      }

      .null-marker {
        font-size: 1rem;
        color: #a0aec0;
        font-style: italic;
      }

      .merge-workspace {
        display: grid;
        grid-template-columns: 1fr 80px 1fr;
        gap: 20px;
        align-items: start;
      }

      @media (max-width: 900px) {
        .merge-workspace {
          grid-template-columns: 1fr;
        }
      }

      .merge-list-container {
        background: #f7fafc;
        border: 3px solid #4299e1;
        border-radius: 12px;
        padding: 15px;
        min-height: 100px;
      }

      .merge-list-title {
        font-family: "Caveat", cursive;
        font-size: 1.3rem;
        margin-bottom: 12px;
        text-align: center;
      }

      .l1-container {
        border-color: #d53f8c;
        background: #fff5f7;
      }

      .l1-container .merge-list-title {
        color: #97266d;
      }

      .l2-container {
        border-color: #38a169;
        background: #f0fff4;
      }

      .l2-container .merge-list-title {
        color: #276749;
      }

      .merge-arrow-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-top: 40px;
      }

      .merge-arrow {
        font-size: 2.5rem;
        color: #ed8936;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
      }

      .compare-box {
        background: #fffaf0;
        border: 2px solid #ed8936;
        border-radius: 8px;
        padding: 8px;
        font-size: 1rem;
        text-align: center;
        margin-top: 10px;
      }

      .result-section {
        background: #f0fff4;
        border-color: #38a169;
      }

      .result-list {
        display: flex;
        align-items: center;
        gap: 5px;
        min-height: 60px;
        flex-wrap: wrap;
        padding: 15px;
        background: #fff;
        border-radius: 8px;
        border: 2px dashed #9ae6b4;
      }

      .result-node {
        width: 48px;
        height: 48px;
        border: 3px solid #38a169;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        font-weight: bold;
        background: #c6f6d5;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        0% {
          transform: translateX(-20px) scale(0.5);
          opacity: 0;
        }
        100% {
          transform: translateX(0) scale(1);
          opacity: 1;
        }
      }

      .result-arrow {
        font-size: 1.4rem;
        color: #38a169;
      }

      .empty-placeholder {
        color: #a0aec0;
        font-style: italic;
        font-size: 1.1rem;
      }

      .complexity-box {
        background: #ebf8ff;
        border: 3px solid #4299e1;
        border-radius: 12px;
        padding: 15px;
        margin-top: 20px;
      }

      .complexity-title {
        font-family: "Caveat", cursive;
        font-size: 1.3rem;
        color: #2b6cb0;
        margin-bottom: 8px;
      }

      .complexity-item {
        font-size: 1.1rem;
        color: #2c5282;
        margin: 5px 0;
      }

      .pointer-legend {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.1rem;
      }

      .legend-dot {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 2px solid;
      }

      .legend-l1 {
        background: #fed7e2;
        border-color: #d53f8c;
      }

      .legend-l2 {
        background: #c6f6d5;
        border-color: #38a169;
      }

      .legend-picked {
        background: #fefcbf;
        border-color: #d69e2e;
      }

      .iteration-counter {
        position: absolute;
        top: 15px;
        right: 20px;
        font-family: "Caveat", cursive;
        font-size: 1.4rem;
        color: #805ad5;
        background: #faf5ff;
        padding: 5px 15px;
        border-radius: 20px;
        border: 2px solid #805ad5;
      }
    </style>
  </head>
  <body>
    <div class="whiteboard">
      <h1>üîó Merge K Sorted Lists</h1>
      <p class="subtitle">
        Sequential Merge Approach - Interactive Visualization
      </p>

      <div class="merge-round-indicator">
        <div class="round-badge" id="round0">üìã Initialize</div>
        <div class="round-badge" id="round1">üîÑ Merge 1: L0 + L1</div>
        <div class="round-badge" id="round2">üîÑ Merge 2: Result + L2</div>
        <div class="round-badge" id="round3">‚úÖ Complete</div>
      </div>

      <div class="step-counter" id="stepCounter">Ready to start!</div>

      <div class="controls">
        <button class="btn btn-primary" id="stepBtn" onclick="nextStep()">
          ‚ñ∂ Step
        </button>
        <button class="btn btn-success" id="autoBtn" onclick="toggleAuto()">
          ‚èµ Auto Play
        </button>
        <button class="btn btn-danger" onclick="reset()">‚Ü∫ Reset</button>
      </div>

      <div class="speed-control">
        <span class="speed-label">Speed:</span>
        <input
          type="range"
          class="speed-slider"
          id="speedSlider"
          min="300"
          max="1500"
          value="700"
        />
        <span class="speed-label" id="speedValue">Medium</span>
      </div>

      <div class="pointer-legend">
        <div class="legend-item">
          <div class="legend-dot legend-l1"></div>
          <span>L1 Pointer</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot legend-l2"></div>
          <span>L2 Pointer</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot legend-picked"></div>
          <span>Picked Node</span>
        </div>
      </div>

      <div class="explanation-box">
        <div class="explanation-title">üí° Current Action:</div>
        <div class="explanation-text" id="explanation">
          Click <strong>Step</strong> to begin, or <strong>Auto Play</strong> to
          watch automatically. <br /><br />
          <strong>Input:</strong> lists = [[1,4,5], [1,3,4], [2,6]]<br />
          <strong>Strategy:</strong> Merge lists one by one: result =
          merge(result, lists[i])
        </div>
      </div>

      <div class="main-content">
        <div class="section">
          <div class="section-title">üìã Input Lists</div>
          <div class="input-lists-container" id="inputLists"></div>
        </div>

        <div class="section" id="mergeSection" style="display: none">
          <div class="section-title">‚öôÔ∏è Merge Workspace</div>
          <div class="iteration-counter" id="iterationCounter">
            Comparison #0
          </div>
          <div class="merge-workspace">
            <div class="merge-list-container l1-container">
              <div class="merge-list-title">L1 (Accumulated Result)</div>
              <div class="linked-list" id="l1Display"></div>
            </div>
            <div class="merge-arrow-container">
              <div class="merge-arrow">‚áÑ</div>
              <div class="compare-box" id="compareBox">‚Äî</div>
            </div>
            <div class="merge-list-container l2-container">
              <div class="merge-list-title">L2 (Next List)</div>
              <div class="linked-list" id="l2Display"></div>
            </div>
          </div>
        </div>

        <div class="section result-section">
          <div class="section-title">‚úÖ Current Merged Result</div>
          <div class="result-list" id="resultList">
            <span class="empty-placeholder">Will build up as we merge...</span>
          </div>
        </div>
      </div>

      <div class="complexity-box">
        <div class="complexity-title">üìä Complexity Analysis</div>
        <div class="complexity-item">
          ‚è±Ô∏è <strong>Time:</strong> O(kN) ‚Äî early lists get re-traversed
          multiple times
        </div>
        <div class="complexity-item">
          üíæ <strong>Space:</strong> O(1) ‚Äî we rewire existing nodes, no extra
          arrays
        </div>
        <div class="complexity-item">
          üìù <strong>Key Insight:</strong> Each merge of two lists is O(n+m),
          but accumulated result grows
        </div>
      </div>
    </div>

    <script>
      // Input data
      const inputLists = [
        [1, 4, 5],
        [1, 3, 4],
        [2, 6],
      ];

      // State
      let currentRound = 0; // 0=init, 1=merge1, 2=merge2, 3=done
      let currentStep = 0;
      let totalSteps = 0;

      // Merge state
      let l1 = [];
      let l2 = [];
      let l1Index = 0;
      let l2Index = 0;
      let mergedResult = [];
      let comparisonCount = 0;

      let isAutoPlaying = false;
      let autoInterval = null;

      // Speed
      const speedSlider = document.getElementById("speedSlider");
      const speedValue = document.getElementById("speedValue");

      speedSlider.addEventListener("input", () => {
        const val = speedSlider.value;
        if (val < 600) speedValue.textContent = "Fast";
        else if (val < 1000) speedValue.textContent = "Medium";
        else speedValue.textContent = "Slow";
      });

      function getSpeed() {
        return parseInt(speedSlider.value);
      }

      function initDisplay() {
        const container = document.getElementById("inputLists");
        container.innerHTML = "";

        inputLists.forEach((list, idx) => {
          const row = document.createElement("div");
          row.className = "list-row";
          row.id = `list-row-${idx}`;

          const label = document.createElement("span");
          label.className = "list-label";
          label.textContent = `List ${idx}:`;
          row.appendChild(label);

          const linkedList = document.createElement("div");
          linkedList.className = "linked-list";
          linkedList.id = `input-list-${idx}`;

          list.forEach((val, nodeIdx) => {
            const node = document.createElement("div");
            node.className = "node";
            node.id = `input-node-${idx}-${nodeIdx}`;
            node.textContent = val;
            linkedList.appendChild(node);

            if (nodeIdx < list.length - 1) {
              const arrow = document.createElement("span");
              arrow.className = "arrow";
              arrow.textContent = "‚Üí";
              linkedList.appendChild(arrow);
            }
          });

          const nullMarker = document.createElement("span");
          nullMarker.className = "null-marker";
          nullMarker.textContent = " ‚Üí null";
          linkedList.appendChild(nullMarker);

          row.appendChild(linkedList);
          container.appendChild(row);
        });
      }

      function updateRoundIndicator() {
        for (let i = 0; i <= 3; i++) {
          const el = document.getElementById(`round${i}`);
          el.className = "round-badge";
          if (i < currentRound) el.classList.add("completed");
          else if (i === currentRound) el.classList.add("active");
        }
      }

      function renderMergeWorkspace() {
        // L1 display
        const l1Display = document.getElementById("l1Display");
        l1Display.innerHTML = "";

        if (l1.length === 0) {
          l1Display.innerHTML = '<span class="empty-placeholder">Empty</span>';
        } else {
          l1.forEach((val, idx) => {
            const node = document.createElement("div");
            node.className = "node";
            if (idx === l1Index && l1Index < l1.length) {
              node.classList.add("pointer-l1");
            }
            if (idx < l1Index) {
              node.classList.add("used");
            }
            node.textContent = val;
            l1Display.appendChild(node);

            if (idx < l1.length - 1) {
              const arrow = document.createElement("span");
              arrow.className = "arrow";
              arrow.textContent = "‚Üí";
              l1Display.appendChild(arrow);
            }
          });
          const nullMarker = document.createElement("span");
          nullMarker.className = "null-marker";
          nullMarker.textContent = " ‚Üí null";
          l1Display.appendChild(nullMarker);
        }

        // L2 display
        const l2Display = document.getElementById("l2Display");
        l2Display.innerHTML = "";

        if (l2.length === 0) {
          l2Display.innerHTML = '<span class="empty-placeholder">Empty</span>';
        } else {
          l2.forEach((val, idx) => {
            const node = document.createElement("div");
            node.className = "node";
            if (idx === l2Index && l2Index < l2.length) {
              node.classList.add("pointer-l2");
            }
            if (idx < l2Index) {
              node.classList.add("used");
            }
            node.textContent = val;
            l2Display.appendChild(node);

            if (idx < l2.length - 1) {
              const arrow = document.createElement("span");
              arrow.className = "arrow";
              arrow.textContent = "‚Üí";
              l2Display.appendChild(arrow);
            }
          });
          const nullMarker = document.createElement("span");
          nullMarker.className = "null-marker";
          nullMarker.textContent = " ‚Üí null";
          l2Display.appendChild(nullMarker);
        }
      }

      function renderResult() {
        const container = document.getElementById("resultList");
        container.innerHTML = "";

        if (mergedResult.length === 0) {
          container.innerHTML =
            '<span class="empty-placeholder">Will build up as we merge...</span>';
          return;
        }

        mergedResult.forEach((val, idx) => {
          const node = document.createElement("div");
          node.className = "result-node";
          node.textContent = val;
          container.appendChild(node);

          if (idx < mergedResult.length - 1) {
            const arrow = document.createElement("span");
            arrow.className = "result-arrow";
            arrow.textContent = "‚Üí";
            container.appendChild(arrow);
          }
        });

        if (currentRound >= 3) {
          const nullMarker = document.createElement("span");
          nullMarker.className = "null-marker";
          nullMarker.style.marginLeft = "5px";
          nullMarker.textContent = "‚Üí null";
          container.appendChild(nullMarker);
        }
      }

      function setExplanation(text) {
        document.getElementById("explanation").innerHTML = text;
      }

      function setStepCounter(text) {
        document.getElementById("stepCounter").textContent = text;
      }

      function setCompareBox(text) {
        document.getElementById("compareBox").innerHTML = text;
      }

      function setIterationCounter(num) {
        document.getElementById(
          "iterationCounter"
        ).textContent = `Comparison #${num}`;
      }

      function startMergeRound(roundNum) {
        document.getElementById("mergeSection").style.display = "block";

        if (roundNum === 1) {
          l1 = [...inputLists[0]];
          l2 = [...inputLists[1]];
          document.getElementById("list-row-0").classList.add("being-merged");
          document.getElementById("list-row-1").classList.add("being-merged");
        } else if (roundNum === 2) {
          l1 = [...mergedResult];
          l2 = [...inputLists[2]];
          document
            .getElementById("list-row-0")
            .classList.remove("being-merged");
          document.getElementById("list-row-0").classList.add("merged-away");
          document
            .getElementById("list-row-1")
            .classList.remove("being-merged");
          document.getElementById("list-row-1").classList.add("merged-away");
          document.getElementById("list-row-2").classList.add("being-merged");
        }

        l1Index = 0;
        l2Index = 0;
        mergedResult = [];
        comparisonCount = 0;

        renderMergeWorkspace();
        renderResult();
        setIterationCounter(0);
      }

      function doMergeStep() {
        const l1Val = l1Index < l1.length ? l1[l1Index] : null;
        const l2Val = l2Index < l2.length ? l2[l2Index] : null;

        // Both exhausted
        if (l1Val === null && l2Val === null) {
          return "done";
        }

        // Only L1 has values
        if (l2Val === null) {
          mergedResult.push(l1Val);
          setCompareBox(`L1: ${l1Val}<br>L2: null<br>Pick: ${l1Val}`);
          setExplanation(
            `L2 is exhausted. Appending remaining L1 node: <strong>${l1Val}</strong><br><br>` +
              `<span class="code-display">current.next = l1</span><br>` +
              `Result: [${mergedResult.join(", ")}]`
          );
          l1Index++;
          comparisonCount++;
          return "continue";
        }

        // Only L2 has values
        if (l1Val === null) {
          mergedResult.push(l2Val);
          setCompareBox(`L1: null<br>L2: ${l2Val}<br>Pick: ${l2Val}`);
          setExplanation(
            `L1 is exhausted. Appending remaining L2 node: <strong>${l2Val}</strong><br><br>` +
              `<span class="code-display">current.next = l2</span><br>` +
              `Result: [${mergedResult.join(", ")}]`
          );
          l2Index++;
          comparisonCount++;
          return "continue";
        }

        // Both have values - compare
        comparisonCount++;
        if (l1Val <= l2Val) {
          mergedResult.push(l1Val);
          setCompareBox(
            `L1: <strong>${l1Val}</strong><br>L2: ${l2Val}<br>Pick: ${l1Val} ‚úì`
          );
          setExplanation(
            `Comparing: L1.val (${l1Val}) ‚â§ L2.val (${l2Val})<br><br>` +
              `Pick <strong>${l1Val}</strong> from L1, advance L1 pointer.<br>` +
              `<span class="code-display">current.next = l1; l1 = l1.next</span><br><br>` +
              `Result: [${mergedResult.join(", ")}]`
          );
          l1Index++;
        } else {
          mergedResult.push(l2Val);
          setCompareBox(
            `L1: ${l1Val}<br>L2: <strong>${l2Val}</strong><br>Pick: ${l2Val} ‚úì`
          );
          setExplanation(
            `Comparing: L1.val (${l1Val}) > L2.val (${l2Val})<br><br>` +
              `Pick <strong>${l2Val}</strong> from L2, advance L2 pointer.<br>` +
              `<span class="code-display">current.next = l2; l2 = l2.next</span><br><br>` +
              `Result: [${mergedResult.join(", ")}]`
          );
          l2Index++;
        }

        return "continue";
      }

      function nextStep() {
        totalSteps++;

        // Round 0: Initialize
        if (currentRound === 0) {
          currentRound = 1;
          updateRoundIndicator();
          startMergeRound(1);
          setStepCounter(
            `Step ${totalSteps}: Starting Merge 1 (List0 + List1)`
          );
          setExplanation(
            `<strong>Starting Merge Round 1</strong><br><br>` +
              `L1 = List0: [${inputLists[0].join(", ")}]<br>` +
              `L2 = List1: [${inputLists[1].join(", ")}]<br><br>` +
              `We'll compare heads and pick the smaller one each time.`
          );
          return;
        }

        // Round 1: Merging List0 + List1
        if (currentRound === 1) {
          const status = doMergeStep();
          setIterationCounter(comparisonCount);
          renderMergeWorkspace();
          renderResult();
          setStepCounter(
            `Step ${totalSteps}: Merge 1 - Comparison #${comparisonCount}`
          );

          if (status === "done") {
            currentRound = 2;
            updateRoundIndicator();
            startMergeRound(2);
            setStepCounter(
              `Step ${totalSteps}: Starting Merge 2 (Result + List2)`
            );
            setExplanation(
              `<strong>Merge Round 1 Complete! ‚úì</strong><br><br>` +
                `Intermediate result: [${l1
                  .concat(l2.slice(l2Index))
                  .join(", ")}]...<br><br>` +
                `Now starting Merge Round 2:<br>` +
                `L1 = Previous Result: [${mergedResult.join(", ")}]<br>` +
                `L2 = List2: [${inputLists[2].join(", ")}]`
            );
            // Reset for visualization of round 2
            setTimeout(() => {
              l1 = [...mergedResult];
              l2 = [...inputLists[2]];
              l1Index = 0;
              l2Index = 0;
              mergedResult = [];
              comparisonCount = 0;
              renderMergeWorkspace();
              renderResult();
              setIterationCounter(0);
            }, 100);
          }
          return;
        }

        // Round 2: Merging Result + List2
        if (currentRound === 2) {
          const status = doMergeStep();
          setIterationCounter(comparisonCount);
          renderMergeWorkspace();
          renderResult();
          setStepCounter(
            `Step ${totalSteps}: Merge 2 - Comparison #${comparisonCount}`
          );

          if (status === "done") {
            currentRound = 3;
            updateRoundIndicator();
            document
              .getElementById("list-row-2")
              .classList.remove("being-merged");
            document.getElementById("list-row-2").classList.add("merged-away");
            document.getElementById("mergeSection").style.display = "none";
            renderResult();
            setStepCounter(`‚úÖ Complete!`);
            setExplanation(
              `<strong>üéâ All merges complete!</strong><br><br>` +
                `Final merged list: <strong>[${mergedResult.join(
                  ", "
                )}]</strong><br><br>` +
                `Summary:<br>` +
                `‚Ä¢ Merge 1: List0 + List1 ‚Üí intermediate result<br>` +
                `‚Ä¢ Merge 2: intermediate + List2 ‚Üí final result<br><br>` +
                `Total: <span class="code-display">O(kN)</span> time, <span class="code-display">O(1)</span> space`
            );
            document.getElementById("stepBtn").disabled = true;
            stopAuto();
          }
          return;
        }
      }

      function toggleAuto() {
        if (isAutoPlaying) {
          stopAuto();
        } else {
          startAuto();
        }
      }

      function startAuto() {
        isAutoPlaying = true;
        document.getElementById("autoBtn").textContent = "‚è∏ Pause";
        document.getElementById("autoBtn").classList.remove("btn-success");
        document.getElementById("autoBtn").classList.add("btn-warning");

        autoInterval = setInterval(() => {
          if (currentRound >= 3) {
            stopAuto();
            return;
          }
          nextStep();
        }, getSpeed());
      }

      function stopAuto() {
        isAutoPlaying = false;
        document.getElementById("autoBtn").textContent = "‚èµ Auto Play";
        document.getElementById("autoBtn").classList.remove("btn-warning");
        document.getElementById("autoBtn").classList.add("btn-success");

        if (autoInterval) {
          clearInterval(autoInterval);
          autoInterval = null;
        }
      }

      function reset() {
        stopAuto();

        currentRound = 0;
        totalSteps = 0;
        l1 = [];
        l2 = [];
        l1Index = 0;
        l2Index = 0;
        mergedResult = [];
        comparisonCount = 0;

        document.getElementById("stepBtn").disabled = false;
        document.getElementById("mergeSection").style.display = "none";

        initDisplay();
        updateRoundIndicator();
        renderResult();

        setStepCounter("Ready to start!");
        setExplanation(
          `Click <strong>Step</strong> to begin, or <strong>Auto Play</strong> to watch automatically.` +
            `<br><br>` +
            `<strong>Input:</strong> lists = [[1,4,5], [1,3,4], [2,6]]<br>` +
            `<strong>Strategy:</strong> Merge lists one by one: result = merge(result, lists[i])`
        );
      }

      // Keyboard support
      document.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
          e.preventDefault();
          if (currentRound < 3) nextStep();
        } else if (e.code === "KeyR") {
          reset();
        } else if (e.code === "KeyA") {
          toggleAuto();
        }
      });

      // Initialize
      initDisplay();
      updateRoundIndicator();
    </script>
  </body>
</html>
